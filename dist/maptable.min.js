this.d3=this.d3||{},this.d3.maptable=function(){"use strict";function t(t,e,a){e.forEach(function(e){var a=document.createElement("option");a.setAttribute("value",e.value),a.innerText=e.text,t.appendChild(a)}),t.value=a}function e(t,e,a){return"="===e?parseInt(t,10)===parseInt(a,10):"≠"===e?parseInt(t,10)!==parseInt(a,10)&&""!==t&&""!==a:">"===e?parseInt(t,10)>parseInt(a,10)&&""!==t&&""!==a:"<"===e?parseInt(t,10)<parseInt(a,10)&&""!==t&&""!==a:"≥"===e?parseInt(t,10)>=parseInt(a,10)&&""!==t&&""!==a:"≤"===e?parseInt(t,10)<=parseInt(a,10)&&""!==t&&""!==a:!0}function a(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?parseInt(e[1],16)+", "+parseInt(e[2],16)+", "+parseInt(e[3],16):null}function i(){for(var t={},e=void 0,a=void 0,n=[].splice.call(arguments,0),r={}.toString;n.length>0;)if(e=n.splice(0,1)[0],"[object Object]"===r.call(e))for(a in e)e.hasOwnProperty(a)&&("[object Object]"===r.call(e[a])?t[a]=i(t[a]||{},e[a]):t[a]=e[a]);return t}function n(t){var e=t.charAt(0).toUpperCase()+t.slice(1);return e.replace(/_/g," ")}function r(t){return t.toLowerCase().replace(/ /g,"_").replace(/"/g,"").replace(/'/g,"")}function s(t,e,a,i){if("string"==typeof t)var t=document.getElementById(t);else if("undefined"!=typeof HTMLImageElement&&!t instanceof HTMLImageElement)return;var n=t.naturalWidth,r=t.naturalHeight;if("string"==typeof e)var e=document.getElementById(e);else if("undefined"!=typeof HTMLCanvasElement&&!e instanceof HTMLCanvasElement)return;e.style.width=n+"px",e.style.height=r+"px",e.width=n,e.height=r;var s=e.getContext("2d");s.clearRect(0,0,n,r),s.drawImage(t,0,0),isNaN(a)||1>a||(i?l(e,0,0,n,r,a):h(e,0,0,n,r,a))}function o(t,e,a,i,n){if("string"==typeof t)var t=document.getElementById(t);else if("undefined"!=typeof HTMLCanvasElement&&!t instanceof HTMLCanvasElement)return;var r,s=t.getContext("2d");try{try{r=s.getImageData(e,a,i,n)}catch(o){throw new Error("unable to access local image data: "+o)}}catch(o){throw new Error("unable to access image data: "+o)}return r}function l(t,e,a,i,n,r){if(!(isNaN(r)||1>r)){r|=0;var s=o(t,e,a,i,n);s=d(s,e,a,i,n,r),t.getContext("2d").putImageData(s,e,a)}}function d(t,e,a,i,n,r){var s,o,l,d,h,p,u,m,f,v,g,k,x,w,C,E,S,A,N,M,T,j,I,D,H=t.data,W=r+r+1,F=i-1,q=n-1,L=r+1,O=L*(L+1)/2,B=new c,R=B;for(l=1;W>l;l++)if(R=R.next=new c,l==L)var z=R;R.next=B;var P=null,X=null;u=p=0;var Y=y[r],V=b[r];for(o=0;n>o;o++){for(E=S=A=N=m=f=v=g=0,k=L*(M=H[p]),x=L*(T=H[p+1]),w=L*(j=H[p+2]),C=L*(I=H[p+3]),m+=O*M,f+=O*T,v+=O*j,g+=O*I,R=B,l=0;L>l;l++)R.r=M,R.g=T,R.b=j,R.a=I,R=R.next;for(l=1;L>l;l++)d=p+((l>F?F:l)<<2),m+=(R.r=M=H[d])*(D=L-l),f+=(R.g=T=H[d+1])*D,v+=(R.b=j=H[d+2])*D,g+=(R.a=I=H[d+3])*D,E+=M,S+=T,A+=j,N+=I,R=R.next;for(P=B,X=z,s=0;i>s;s++)H[p+3]=I=g*Y>>V,0!=I?(I=255/I,H[p]=(m*Y>>V)*I,H[p+1]=(f*Y>>V)*I,H[p+2]=(v*Y>>V)*I):H[p]=H[p+1]=H[p+2]=0,m-=k,f-=x,v-=w,g-=C,k-=P.r,x-=P.g,w-=P.b,C-=P.a,d=u+((d=s+r+1)<F?d:F)<<2,E+=P.r=H[d],S+=P.g=H[d+1],A+=P.b=H[d+2],N+=P.a=H[d+3],m+=E,f+=S,v+=A,g+=N,P=P.next,k+=M=X.r,x+=T=X.g,w+=j=X.b,C+=I=X.a,E-=M,S-=T,A-=j,N-=I,X=X.next,p+=4;u+=i}for(s=0;i>s;s++){for(S=A=N=E=f=v=g=m=0,p=s<<2,k=L*(M=H[p]),x=L*(T=H[p+1]),w=L*(j=H[p+2]),C=L*(I=H[p+3]),m+=O*M,f+=O*T,v+=O*j,g+=O*I,R=B,l=0;L>l;l++)R.r=M,R.g=T,R.b=j,R.a=I,R=R.next;for(h=i,l=1;r>=l;l++)p=h+s<<2,m+=(R.r=M=H[p])*(D=L-l),f+=(R.g=T=H[p+1])*D,v+=(R.b=j=H[p+2])*D,g+=(R.a=I=H[p+3])*D,E+=M,S+=T,A+=j,N+=I,R=R.next,q>l&&(h+=i);for(p=s,P=B,X=z,o=0;n>o;o++)d=p<<2,H[d+3]=I=g*Y>>V,I>0?(I=255/I,H[d]=(m*Y>>V)*I,H[d+1]=(f*Y>>V)*I,H[d+2]=(v*Y>>V)*I):H[d]=H[d+1]=H[d+2]=0,m-=k,f-=x,v-=w,g-=C,k-=P.r,x-=P.g,w-=P.b,C-=P.a,d=s+((d=o+L)<q?d:q)*i<<2,m+=E+=P.r=H[d],f+=S+=P.g=H[d+1],v+=A+=P.b=H[d+2],g+=N+=P.a=H[d+3],P=P.next,k+=M=X.r,x+=T=X.g,w+=j=X.b,C+=I=X.a,E-=M,S-=T,A-=j,N-=I,X=X.next,p+=i}return t}function h(t,e,a,i,n,r){if(!(isNaN(r)||1>r)){r|=0;var s=o(t,e,a,i,n);s=p(s,e,a,i,n,r),t.getContext("2d").putImageData(s,e,a)}}function p(t,e,a,i,n,r){var s,o,l,d,h,p,u,m,f,v,g,k,x,w,C,E,S,A,N,M,T=t.data,j=r+r+1,I=i-1,D=n-1,H=r+1,W=H*(H+1)/2,F=new c,q=F;for(l=1;j>l;l++)if(q=q.next=new c,l==H)var L=q;q.next=F;var O=null,B=null;u=p=0;var R=y[r],z=b[r];for(o=0;n>o;o++){for(w=C=E=m=f=v=0,g=H*(S=T[p]),k=H*(A=T[p+1]),x=H*(N=T[p+2]),m+=W*S,f+=W*A,v+=W*N,q=F,l=0;H>l;l++)q.r=S,q.g=A,q.b=N,q=q.next;for(l=1;H>l;l++)d=p+((l>I?I:l)<<2),m+=(q.r=S=T[d])*(M=H-l),f+=(q.g=A=T[d+1])*M,v+=(q.b=N=T[d+2])*M,w+=S,C+=A,E+=N,q=q.next;for(O=F,B=L,s=0;i>s;s++)T[p]=m*R>>z,T[p+1]=f*R>>z,T[p+2]=v*R>>z,m-=g,f-=k,v-=x,g-=O.r,k-=O.g,x-=O.b,d=u+((d=s+r+1)<I?d:I)<<2,w+=O.r=T[d],C+=O.g=T[d+1],E+=O.b=T[d+2],m+=w,f+=C,v+=E,O=O.next,g+=S=B.r,k+=A=B.g,x+=N=B.b,w-=S,C-=A,E-=N,B=B.next,p+=4;u+=i}for(s=0;i>s;s++){for(C=E=w=f=v=m=0,p=s<<2,g=H*(S=T[p]),k=H*(A=T[p+1]),x=H*(N=T[p+2]),m+=W*S,f+=W*A,v+=W*N,q=F,l=0;H>l;l++)q.r=S,q.g=A,q.b=N,q=q.next;for(h=i,l=1;r>=l;l++)p=h+s<<2,m+=(q.r=S=T[p])*(M=H-l),f+=(q.g=A=T[p+1])*M,v+=(q.b=N=T[p+2])*M,w+=S,C+=A,E+=N,q=q.next,D>l&&(h+=i);for(p=s,O=F,B=L,o=0;n>o;o++)d=p<<2,T[d]=m*R>>z,T[d+1]=f*R>>z,T[d+2]=v*R>>z,m-=g,f-=k,v-=x,g-=O.r,k-=O.g,x-=O.b,d=s+((d=o+H)<D?d:D)*i<<2,m+=w+=O.r=T[d],f+=C+=O.g=T[d+1],v+=E+=O.b=T[d+2],O=O.next,g+=S=B.r,k+=A=B.g,x+=N=B.b,w-=S,C-=A,E-=N,B=B.next,p+=i}return t}function c(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}var u={};u["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},u.classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},u.createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,a,i){return a&&t(e.prototype,a),i&&t(e,i),e}}();var m={rangeToBool:e,appendOptions:t,extendRecursive:i,sanitizeKey:r,keyToTile:n,hexToRgb:a},f={map:{longitudeKey:"longitude",latitudeKey:"latitude",countryIdentifierKey:"country_code",countryIdentifierType:"iso_a2",zoom:!0,ratioFromWidth:.5,scaleHeight:1,scaleZoom:[1,10],fitContentMargin:10,autoFitContent:!1,tooltipClassName:"popover bottom",countries:{legend:!1,attr:{fill:"#FCFCFC",stroke:"#CCC","stroke-width":.5},tooltipClassName:"mt-map-tooltip popover bottom"},heatmap:{mask:!0,circles:{min:1,max:90,step:2,color:"#FF0000",blur:4,magnitudeScale:function(){var t=d3.scale.linear().domain([1,100]).range([.7,1.05]),e=this.data.length,a=t(e)/e,i=d3.scale.linear().domain([this.options.map.heatmap.circles.min,this.options.map.heatmap.circles.max]).range([a,0]);return function(t){return i(t)}}},borders:{stroke:1,opacity:.1,color:"#000"}},markers:{attr:{r:4,fill:"blue",stroke:"#CCC","stroke-width":.5},tooltipClassName:"mt-map-tooltip popover bottom"},title:{fontSize:12,fontFamily:"Helevetica, Arial, Sans-Serif"}},table:{className:"table table-striped table-bordered",collapseRowsBy:[]}},v=function(){function t(e){u.classCallCheck(this,t),this.legendWidth=220,this.map=e,this.node=this.map.svg.append("g").attr("id","mt-map-legend").attr("transform","translate("+(this.map.getWidth()-350)+", "+(this.map.getHeight()-60)+")"),this.buildIndice()}return u.createClass(t,[{key:"buildScale",value:function(t){var e=this.node.append("defs").append("linearGradient").attr("id","mt-map-legend-gradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%");if(this.map.options.countries.attr.fill.minNegative&&this.map.options.countries.attr.fill.maxNegative){var a=Math.round((0-t[0])/(t[1]-t[0])*100),i=a+1;e.append("stop").attr("offset","0%").attr("style","stop-color:"+this.map.options.countries.attr.fill.maxNegative+";stop-opacity:1"),e.append("stop").attr("offset",a+"%").attr("style","stop-color:"+this.map.options.countries.attr.fill.minNegative+";stop-opacity:1"),e.append("stop").attr("offset",i+"%").attr("style","stop-color:"+this.map.options.countries.attr.fill.min+";stop-opacity:1")}else e.append("stop").attr("offset","0%").attr("style","stop-color:"+this.map.options.countries.attr.fill.min+";stop-opacity:1");e.append("stop").attr("offset","100%").attr("style","stop-color:"+this.map.options.countries.attr.fill.max+";stop-opacity:1"),this.node.append("rect").attr("x",40).attr("y",0).attr("width",this.legendWidth).attr("height",15).attr("fill","url(#mt-map-legend-gradient)")}},{key:"buildIndice",value:function(){var t=this.node.append("g").attr("id","mt-map-legend-indice").attr("style","display:none").attr("transform","translate(36,15)");t.append("polygon").attr("points","4.5 0 9 5 0 5").attr("fill","#222222"),t.append("text").attr("x",4).attr("y",13).attr("width",10).attr("height",10).attr("text-anchor","middle").attr("font-family","Arial").attr("font-size","9").attr("stroke","#FFFFF").attr("stroke-width","1").attr("fill","#222222").text("0"),this.node.append("text").attr("id","mt-map-legend-min").attr("x",35).attr("y",13).attr("width",35).attr("height",15).attr("text-anchor","end").attr("font-family","Arial").attr("font-size","14").attr("stroke","#FFFFF").attr("stroke-width","3").attr("fill","#222222").text("0"),this.node.append("text").attr("id","mt-map-legend-max").attr("y",13).attr("x",265).attr("width",40).attr("height",15).attr("text-anchor","start").attr("font-family","Arial").attr("font-size","14").attr("stroke","#FFFFF").attr("stroke-width","3").attr("fill","#222222").text("1")}},{key:"updateExtents",value:function(t){document.getElementById("mt-map-legend").style.opacity=t[0]===t[1]?0:1,document.getElementById("mt-map-legend-min")&&(this.node.select("#mt-map-legend-min").text(Math.round(t[0])),this.node.select("#mt-map-legend-max").text(Math.round(t[1])),this.buildScale(t))}},{key:"indiceChange",value:function(t){if(isNaN(t))this.node.select("#mt-map-legend-indice").attr("style","display:none");else{var e=parseInt(this.node.select("#mt-map-legend-max").text(),10),a=parseInt(this.node.select("#mt-map-legend-min").text(),10),i=Math.round((0-(a-t)/(e-a))*this.legendWidth);this.node.select("#mt-map-legend-indice text").text(Math.round(t)),this.node.select("#mt-map-legend-indice").attr("style","display:block").attr("transform","translate("+(36+i)+",15)")}}}]),t}(),g=function(){function t(e,a){return u.classCallCheck(this,t),this.map=e,this.src=a.src,this.position=a.position,this.width=parseInt(a.width,10),this.height=parseInt(a.height,10),this.padding=a.padding||10,this.style=a.style,a.src?isNaN(this.width)?void console.warn("Watermak width not found"):isNaN(this.height)?void console.warn("Watermak height not found"):void(window.btoa?this.buildWatermark():console.warn("Watermark not rendered: btoa error")):void console.warn("Watermak src not found")}return u.createClass(t,[{key:"buildWatermark",value:function(){var t=this;d3.xhr(this.src,function(e){var a=0;t.map.options.title&&(a=30);var i=void 0,n=void 0,r=void 0;if(-1!==t.src.indexOf(".svg"))i="image/svg+xml";else if(-1!==t.src.indexOf(".jpg")||-1!==t.src.indexOf(".jpeg"))i="image/jpeg";else{if(-1===t.src.indexOf(".png"))return void console.warn("invalid watermark mime type");i="image/png"}var s="data:"+i+";base64,"+window.btoa(e.responseText);if(t.position){var o=t.position.split(" ");"top"===o[0]?r=t.padding:"middle"===o[0]?r=(t.map.getHeight()-t.height)/2:"bottom"===o[0]?r=t.map.getHeight()-t.height-t.padding-a:console.warn("position should be (top|middle|bottom) (left|middle|right)"),"left"===o[1]?n=t.padding:"middle"===o[1]?n=(t.map.getWidth()-t.width)/2:"right"===o[1]?n=t.map.getWidth()-t.width-t.padding:console.warn("position should be (top|middle|bottom) (left|middle|right)")}t.node=t.map.svg.append("image").attr("xlink:href",s).attr("width",t.width).attr("height",t.height),n&&r&&t.node.attr("x",n).attr("y",r),t.style&&t.node.attr("style",t.style)})}}]),t}(),y=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],b=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],k={image:s,canvasRGBA:l,canvasRGB:h,imageDataRGBA:d,imageDataRGB:p},x=function(){function t(e,a,i){var n=this;u.classCallCheck(this,t);var r=this;if(this.maptable=e,this.scale=1,this.transX=0,this.transY=0,this.options=a,this.jsonWorld=i,this.node=document.querySelector("#mt-map"),!this.node){var s=document.querySelector(".mt-map-container");this.node=document.createElement("div"),this.node.setAttribute("id","mt-map"),s.appendChild(this.node)}this.svg=d3.select(this.node).append("svg").attr("id","mt-map-svg").attr("viewBox","0 0 "+this.getWidth()+" "+this.getHeight()).attr("width",this.getWidth()).attr("height",this.getHeight()),this.projection=d3.geo.equirectangular().translate([this.getWidth()/2,this.getHeight()/(2*this.options.scaleHeight)]).scale(this.getWidth()/640*100).rotate([-12,0]).precision(.1),this.path=d3.geo.path().projection(this.projection),this.maptable.rawData.forEach(function(t){t.longitude=parseFloat(t[r.options.longitudeKey]),t.latitude=parseFloat(t[r.options.latitudeKey]);var e=[0,0];isNaN(t.longitude)||isNaN(t.latitude)||(e=r.projection([t.longitude,t.latitude])),t.x=e[0],t.y=e[1]}),this.zoomListener=d3.behavior.zoom().scaleExtent(this.options.scaleZoom).on("zoom",this.rescale.bind(this)),this.options.zoom&&(this.svg=this.svg.call(this.zoomListener.bind(this))),this.tooltipMarkersNode=d3.select(this.node).append("div").attr("id","mt-map-markers-tooltip").attr("class","mt-map-tooltip "+this.options.markers.tooltipClassName).style("display","none"),this.options.countries&&(this.tooltipCountriesNode=d3.select(this.node).append("div").attr("id","mt-map-countries-tooltip").attr("class","mt-map-tooltip "+this.options.countries.tooltipClassName).style("display","none")),this.layerGlobal=this.svg.append("g").attr("class","mt-map-global"),this.layerCountries=this.layerGlobal.append("g").attr("class","mt-map-countries"),this.layerHeatmap=this.layerGlobal.append("g").attr("class","mt-map-heatmap"),this.layerMarkers=this.layerGlobal.append("g").attr("class","mt-map-markers"),this.options.watermark&&(this.watermark=new g(this,this.options.watermark)),this.options.title&&this.buildTitle(),this.options.exportSvg&&this.addExportSvgCapability(),this.options.width||window.addEventListener("resize",function(){n.svg.attr("width",n.getWidth()),n.svg.attr("height",n.getHeight()),n.rescale()}),this.loadGeometries()}return u.createClass(t,[{key:"scaleAttributes",value:function(){return Math.pow(this.scale,2/3)}},{key:"getWidth",value:function(){return this.options.width?this.options.width:this.node.offsetWidth}},{key:"getHeight",value:function(){var t=this.options.title?30:0;return!this.options.height&&this.options.ratioFromWidth?this.getWidth()*this.options.ratioFromWidth*this.options.scaleHeight+t:this.options.height*this.options.scaleHeight+t}},{key:"loadGeometries",value:function(){this.options.filterCountries&&(this.jsonWorld.objects.countries.geometries=this.jsonWorld.objects.countries.geometries.filter(this.options.filterCountries)),this.options.countries&&this.buildCountries(),this.options.heatmap&&this.buildHeatmap(),this.render()}},{key:"buildHeatmap",value:function(){var t=topojson.merge(this.jsonWorld,this.jsonWorld.objects.countries.geometries);if(this.options.heatmap.disableMask||(this.maskHeatmap=this.layerHeatmap.append("defs").append("clipPath").attr("id","mt-map-heatmap-mask"),this.maskHeatmap.datum(t).append("path").attr("class","mt-map-heatmap-mask-paths").attr("d",this.path)),this.canvasHeatmap=d3.select(this.node).append("canvas").attr("id","mt-map-heatmap-canvas").attr("width",this.getWidth()).attr("height",this.getHeight()).attr("style","display: none;"),this.imgHeatmap=this.layerHeatmap.append("image").attr("width","100%").attr("height","100%").attr("class","mt-map-heatmap-img"),this.options.heatmap.mask&&(this.imgHeatmap=this.imgHeatmap.attr("clip-path","url(#mt-map-heatmap-mask)")),this.options.heatmap.borders){var e=topojson.mesh(this.jsonWorld,this.jsonWorld.objects.countries,function(t,e){return t!==e});this.bordersHeatmap=this.layerHeatmap.append("g").attr("class","mt-map-heatmap-borders"),this.bordersHeatmap.selectAll("path.mt-map-heatmap-borders-paths").data([t,e]).enter().append("path").attr("class","mt-map-heatmap-borders-paths").attr("fill","transparent").attr("stroke-width",this.options.heatmap.borders.stroke).attr("stroke",this.options.heatmap.borders.color).attr("style","opacity: "+this.options.heatmap.borders.opacity).attr("d",this.path)}}},{key:"getHeatmapData",value:function(){var t=this.canvasHeatmap.node().getContext("2d"),e=d3.range(this.options.heatmap.circles.min,this.options.heatmap.circles.max,this.options.heatmap.circles.step),a=this.path.context(t),i=m.hexToRgb(this.options.heatmap.circles.color),n=this.options.heatmap.circles.magnitudeScale.bind(this.maptable)(),r=this.options.heatmap.circles.datumScale?this.options.heatmap.circles.datumScale.bind(this.maptable)():function(){return 1};return this.maptable.data.forEach(function(s){var o=[s.longitude,s.latitude],l=r(s);e.forEach(function(e){t.beginPath(),a(d3.geo.circle().origin(o).angle(e-1e-4)());var r=n(e)*l;t.fillStyle="rgba("+i+", "+r+")",t.fill(),t.closePath()})}),k.canvasRGBA(this.canvasHeatmap.node(),0,0,this.getWidth(),this.getHeight(),this.options.heatmap.circles.blur),this.canvasHeatmap.node().toDataURL()}},{key:"updateHeatmap",value:function(){var t=this.getHeatmapData();this.imgHeatmap.attr("xlink:href",t).attr("style","filter: blur(5px)")}},{key:"buildCountries",value:function(){this.dataCountries=topojson.feature(this.jsonWorld,this.jsonWorld.objects.countries).features,this.layerCountries.selectAll(".mt-map-country").data(this.dataCountries).enter().insert("path").attr("class","mt-map-country").attr("d",this.path),this.legendCountry={},this.options.countries.attr.fill&&this.options.countries.attr.fill.legend&&this.options.countries.attr.fill.min&&this.options.countries.attr.fill.max&&(this.legendCountry.fill=new v(this))}},{key:"updateCountries",value:function(){var t=this,e=d3.nest().key(function(e){return e[t.options.countryIdentifierKey]}).entries(this.maptable.data);this.dataCountries.forEach(function(a){a.key=a.properties[t.options.countryIdentifierType];var i=e.filter(function(t){return t.key===a.key});a.values=0===i.length?[]:i[0].values,a.attr={},a.rollupValue={}}),Object.keys(this.options.countries.attr).forEach(function(e){t.setAttrValues(e,t.options.countries.attr[e],t.dataCountries)});var a=d3.selectAll(".mt-map-country").each(function(t){var e=this;Object.keys(t.attr).forEach(function(a){d3.select(e).attr(a,t.attr[a])})});Object.keys(this.options.countries.attr).forEach(function(e){var i=t.options.countries.attr[e];if("object"===("undefined"==typeof i?"undefined":u["typeof"](i))&&i.legend){var n=d3.extent(t.dataCountries,function(t){return Number(t.rollupValue[e])});t.legendCountry[e].updateExtents(n),a.on("mouseover",function(a){t.legendCountry[e].indiceChange(a.rollupValue[e])}).on("mouseout",function(){t.legendCountry[e].indiceChange(NaN)})}}),this.options.countries&&this.options.countries.tooltip&&this.activateTooltip(a,this.tooltipCountriesNode,this.options.countries.tooltip)}},{key:"updateMarkers",value:function(){var t=this,e=function(t){return t.longitude+","+t.latitude};this.dataMarkers=d3.nest().key(e).entries(this.maptable.data).filter(function(t){return 0!==t.values[0].x}),this.dataMarkers.forEach(function(t){t.attr={},t.rollupValue={}}),Object.keys(this.options.markers.attr).forEach(function(e){t.setAttrValues(e,t.options.markers.attr[e],t.dataMarkers)});var a=this.layerMarkers.selectAll(".mt-map-marker").data(this.dataMarkers),i=a.enter();i=this.options.markers.customTag?this.options.markers.customTag(i):i.append("svg:circle");var n=this.options.markers.className?this.options.markers.className:"";i.attr("class","mt-map-marker "+n),a.exit().transition().attr("r",0).attr("fill","#eee").style("opacity",0).remove();var r=this.options.markers.attrX?this.options.markers.attrX:"cx",s=this.options.markers.attrY?this.options.markers.attrY:"cy",o=this.options.markers.attrXDelta?this.options.markers.attrXDelta:0,l=this.options.markers.attrYDelta?this.options.markers.attrYDelta:0,d=a.attr(r,function(t){return t.values[0].x+o}).attr(s,function(t){return t.values[0].y+l});d3.selectAll(".mt-map-marker").each(function(t){var e=this;Object.keys(t.attr).forEach(function(a){d3.select(e).attr(a,t.attr[a])})}),this.options.markers.tooltip&&this.activateTooltip(d,this.tooltipMarkersNode,this.options.markers.tooltip)}},{key:"fitContent",value:function(){if(0===this.maptable.data.length)return this.transX=0,this.transY=0,this.scale=1,this.zoomListener.translate([this.transX,this.transY]).scale(this.scale),!0;var t=d3.extent(this.maptable.data,function(t){return t.x}),e=d3.extent(this.maptable.data,function(t){return t.y}),a=this.getWidth()/this.getHeight(),i=20+(this.options.title?30:0),n=t[1]-t[0]+i,r=e[1]-e[0]+i,s=n/a,o=r*a,l=0,d=0;o>=n?l=(o-n)/2:d=(s-r)/2,t[0]-=this.options.fitContentMargin+l,t[1]+=this.options.fitContentMargin+l,e[0]-=this.options.fitContentMargin+d,e[1]+=this.options.fitContentMargin+d,this.scale=this.getWidth()/(t[1]-t[0]),this.transX=-1*t[0]*this.scale,this.transY=-1*e[0]*this.scale,this.zoomListener.translate([this.transX,this.transY]).scale(this.scale)}},{key:"buildTitle",value:function(){var t=this.svg.append("svg").attr("width",this.getWidth()).attr("x",0).attr("y",this.getHeight()-30).attr("height",30);this.options.title.bgColor&&t.append("rect").attr("x",0).attr("y",0).attr("width",this.getWidth()).attr("height",30).attr("fill",this.options.title.bgColor),t.append("text").attr("id","mt-map-title").attr("x",20).attr("font-size",this.options.title.fontSize).attr("font-family",this.options.title.fontFamily).attr("y",20),this.options.title.source&&t.append("text").attr("y",20).attr("x",this.getWidth()-20).attr("text-anchor","end").attr("font-size",this.options.title.fontSize).attr("font-family",this.options.title.fontFamily).html(this.options.title.source())}},{key:"rescale",value:function(){var t=this;d3.event&&d3.event.translate&&(this.scale=d3.event.scale,this.transX=1===this.scale?0:d3.event.translate[0],this.transY=1===this.scale?0:d3.event.translate[1]);var e=0,a=0,i=this.getWidth()*(1-this.scale),n=this.getHeight()*(1-this.scale);this.transY>a?this.transY=a:this.transY<n&&(this.transY=n),this.transX>e?this.transX=e:this.transX<i&&(this.transX=i),d3.event&&d3.event.translate&&(d3.event.translate[0]=this.transX,d3.event.translate[1]=this.transY),this.layerGlobal.attr("transform","translate("+this.transX+", "+this.transY+")scale("+this.scale+")"),t.tooltipCountriesNode&&t.tooltipCountriesNode.attr("style","display:none;"),t.tooltipMarkersNode&&t.tooltipMarkersNode.attr("style","display:none;"),this.options.markers&&d3.selectAll(".mt-map-marker").each(function(e){e.attr["stroke-width"]&&d3.select(this).attr("stroke-width",e.attr["stroke-width"]/t.scaleAttributes()),e.attr.r&&d3.select(this).attr("r",e.attr.r/t.scaleAttributes())}),this.options.countries&&d3.selectAll(".mt-map-country").style("stroke-width",this.options.countries.attr["stroke-width"]/this.scale),this.options.heatmap&&this.options.heatmap.borders&&d3.selectAll(".mt-map-heatmap-borders-paths").style("stroke-width",this.options.heatmap.borders.stroke/this.scale)}},{key:"setAttrValues",value:function(t,e,a){var i=this;if("number"==typeof e||"string"==typeof e)a.forEach(function(a){a.attr[t]=e});else{if("object"!==("undefined"==typeof e?"undefined":u["typeof"](e)))throw new Error("Maptable: Invalid value for "+t);!function(){if(e.rollup||(e.rollup=function(t){return t.length}),!e.min||!e.max)throw new Error("MapTable: You should provide values 'min' & 'max' for attr."+t);a.forEach(function(a){a.rollupValue[t]=e.rollup(a.values)});var n=d3.extent(a,function(e){return Number(e.rollupValue[t])});e.transform&&(n[0]=e.transform(n[0]),n[1]=e.transform(n[1]));var r=e.min,s=e.max;if("minValue"===e.min&&(r=n[0]),"maxValue"===e.max&&(s=n[1]),e.maxNegative&&!e.minNegative||!e.maxNegative&&e.minNegative)throw new Error("MapTable: maxNegative or minNegative undefined. Please declare both.");var o=e.maxNegative&&e.minNegative,l=void 0,d=void 0;o?(l=d3.scale.linear().domain([0,n[1]]).range([r,s]),d=d3.scale.linear().domain([n[0],0]).range([e.maxNegative,e.minNegative])):l=d3.scale.linear().domain(n).range([r,s]),a.forEach(function(a){var n=void 0;if(!a.values.length||isNaN(a.rollupValue[t])){if("undefined"==typeof e.empty)throw new Error("MapTable: no empty property found for attr."+t);n=e.empty}else{var r=a.rollupValue[t],s=e.transform?e.transform(r,i.maptable.rawData):r;n=o&&0>s?d(s):l(s)}a.attr[t]=n})}()}}},{key:"render",value:function(){this.options.markers&&this.updateMarkers(),this.options.countries&&this.updateCountries(),this.options.title&&this.updateTitle(),this.options.heatmap&&this.updateHeatmap(),this.options.autoFitContent&&(this.fitContent(),this.rescale())}},{key:"updateTitle",value:function(){var t=this;if(this.options.title.content){var e=this.maptable.data.filter(function(e){return 0!==e[t.options.latitudeKey]}).length,a=this.maptable.rawData.filter(function(e){return 0!==e[t.options.latitudeKey]}).length,i="";this.maptable.filters&&(i=this.maptable.filters.getDescription()),document.getElementById("mt-map-title").innerHTML=this.options.title.content(e,a,i)}}},{key:"activateTooltip",value:function(t,e,a,i){var n=this;t.on("mousemove",function(t){var r=d3.mouse(n.svg.node()).map(function(t){return parseInt(t,10)}),s=e.node().offsetWidth/2,o=r[0]-s,l=r[1]+10;e.attr("style","top:"+l+"px;left:"+o+"px;display:block;").html(a(t)).on("mouseout",function(){return e.style("display","none")}),i&&e.on("click",i)}).on("mouseout",function(){return e.style("display","none")})}},{key:"exportSvg",value:function(){var t=document.getElementById("mt-map-svg"),e=(new XMLSerializer).serializeToString(t),a=document.getElementById("mt-map-svg-form");a.querySelector('[name="data"]').value=e,a.submit()}},{key:"addExportSvgCapability",value:function(){var t=document.createElement("div");t.setAttribute("id","mt-map-export"),document.getElementById("mt-map").appendChild(t);var e=document.createElement("button");e.setAttribute("class","btn btn-xs btn-default"),e.innerHTML="Download",e.addEventListener("click",this.exportSvg.bind(this)),t.appendChild(e);var a=document.createElement("div");a.innerHTML='<form id="mt-map-svg-form" method="post"\n      action="'+this.options.exportSvg+'"><input type="hidden" name="data"></form>',t.appendChild(a)}}]),t}(),w=function(){function t(e,a){var i=this;if(u.classCallCheck(this,t),this.maptable=e,this.options=a,this.criteria=[],this.options.show){var n=this.options.show.filter(function(t){return Object.keys(i.maptable.columnDetails).indexOf(t)<0});if(n.length>0)throw new Error('MapTable: invalid columns "'+n.join(", ")+'"');this.activeColumns=this.options.show}else this.activeColumns=Object.keys(this.maptable.columnDetails);this.container=document.createElement("div"),this.maptable.node.appendChild(this.container),this.node=document.querySelector("#mt-filters"),this.node||(this.node=document.createElement("div"),this.node.setAttribute("id","mt-filters"),this.node.setAttribute("class","panel panel-default"),this.maptable.node.appendChild(this.node));var r=document.createElement("div");r.setAttribute("class","panel-heading");var s=document.createElement("button");s.setAttribute("id","mt-filters-reset"),s.setAttribute("class","btn btn-default btn-xs pull-right"),s.style.display="none",s.style.marginLeft=5,s.innerText="↺ Reset",s.addEventListener("click",this.reset),r.appendChild(s);var o=document.createElement("h3");o.setAttribute("class","panel-title"),o.appendChild(document.createTextNode("Filters")),r.appendChild(o),this.node.appendChild(r);var l=document.createElement("div");l.setAttribute("id","mt-filters-content"),l.setAttribute("class","panel-body");var d=document.createElement("div");d.setAttribute("id","mt-filters-elements"),l.appendChild(d);var h=document.createElement("a");h.setAttribute("id","mt-filters-new"),h.setAttribute("href","#"),h.innerText="+ New filter",h.addEventListener("click",this.add.bind(this)),l.appendChild(h),this.node.appendChild(l)}return u.createClass(t,[{key:"add",value:function(t){t.preventDefault();var e=this.getPossibleFilters();if(0!==e.length){var a=e[0].key;this.create(a)}}},{key:"create",value:function(t,e){var a=this.buildRow(t);e?e.parentNode.replaceChild(a,e):document.querySelector("#mt-filters-elements").appendChild(a),this.criteria.push(t),this.maptable.render(),"none"===this.container.style.display&&this.toggle()}},{key:"remove",value:function(t){var e=document.querySelector('[data-mt-filter-name="'+t+'"]');e&&e.parentNode.removeChild(e);var a=this.criteria.indexOf(t);this.criteria.splice(a,1),this.maptable.render()}},{key:"reset",value:function(){this.criteria=[],this.container.innerHTML="",this.refresh(),this.maptable.map.reset()}},{key:"getDescription",value:function(){for(var t=[],e=document.querySelector("#mt-filters-elements").childNodes,a=0;a<e.length;a++){var i=e[a],n=i.querySelector(".mt-filter-name").value,r=this.maptable.columnDetails[n],s="";if("compare"===r.filterMethod){var o=i.querySelector(".mt-filter-range");if("any"!==o.value)if("BETWEEN"===o.value){var l=i.querySelector(".mt-filter-value-min").value,d=i.querySelector(".mt-filter-value-max").value;if(""===l||""===d)continue;s+=r.title+" is between ",s+='<tspan font-weight="bold">'+l+'</tspan> and\n              <tspan font-weight="bold">'+d+"</tspan>"}else{var h=i.querySelector(".mt-filter-value-min").value;if(""===h)continue;s+=r.title+" is ",s+=o.options[o.selectedIndex].text,s+='<tspan font-weight="bold">'+h+"</tspan>"}}else if("field"===r.filterMethod||"dropdown"===r.filterMethod){var p=i.querySelector(".mt-filter-value").value;if(""===p)continue;var c="field"===r.filterMethod?"contains":"is";s+=r.title+" "+c+'\n          <tspan font-weight="bold">'+p+"</tspan>"}t.push(s)}return t.join(", ")}},{key:"buildRow",value:function(t){var e=this,a=this,i=this.getPossibleFilters(),n=this.maptable.columnDetails[t],r=document.createElement("div");r.setAttribute("class","mt-filter-row"),r.setAttribute("data-mt-filter-name",t);var s=document.createElement("button");s.setAttribute("class","btn btn-default pull-right"),s.setAttribute("data-mt-filter-btn-minus",1),s.innerText="– Remove this filter",s.addEventListener("click",function(){t=r.querySelector(".mt-filter-name").value,e.remove(t)}),r.appendChild(s);var o=document.createElement("span");
o.setAttribute("class","mt-filters-and"),o.innerText="And ",r.appendChild(o);var l=document.createElement("select");l.setAttribute("class","mt-filter-name form-control form-control-inline"),m.appendOptions(l,i.map(function(t){return{text:t.title,value:t.key}})),l.value=t,l.addEventListener("change",function(){var t=this.parentNode.getAttribute("data-mt-filter-name"),e=this.value;a.create(e,this.parentNode),a.remove(t),a.refresh()}),r.appendChild(l);var d=document.createElement("span");d.innerText="field"===n.filterMethod?" contains ":" is ",r.appendChild(d);var h=null;"field"!==n.filterMethod&&"dropdown"!==n.filterMethod&&(h=document.createElement("select"),h.setAttribute("class","mt-filter-range form-control form-control-inline"),m.appendOptions(h,["any","=","≠","<",">","≤","≥","BETWEEN"].map(function(t){return{text:t,value:t}})),h.addEventListener("change",function(){a.handleRangeChange(this)}),r.appendChild(h),r.appendChild(document.createTextNode(" ")));var p=document.createElement("div");if(p.style.display="inline-block",p.setAttribute("class","mt-filter-value-container"),"compare"===n.filterMethod)["min","max"].forEach(function(t,a){var i=document.createElement("input");if(i.setAttribute("class","form-control form-control-inline mt-filter-value-"+t),i.setAttribute("type",n.filterInputType),i.addEventListener("keyup",e.maptable.render.bind(e.maptable)),i.addEventListener("change",e.maptable.render.bind(e.maptable)),p.appendChild(i),0===a){var r=document.createElement("span");r.setAttribute("class","mt-filter-value-and"),r.innerText=" and ",p.appendChild(r)}});else if("field"===n.filterMethod){var c=document.createElement("input");c.setAttribute("class","form-control form-control-inline mt-filter-value"),c.setAttribute("type","text"),c.addEventListener("keyup",this.maptable.render.bind(this.maptable)),c.addEventListener("change",this.maptable.render.bind(this.maptable)),p.appendChild(c)}else if("dropdown"===n.filterMethod){var u=document.createElement("select");u.setAttribute("class","form-control form-control-inline mt-filter-value");var f=d3.nest().key(function(e){return e[t]}).sortKeys(d3.ascending).entries(this.maptable.rawData);m.appendOptions(u,[{text:"Any",value:""}].concat(f.map(function(t){return{text:t.key,value:t.key}}))),u.addEventListener("change",this.maptable.render.bind(this.maptable)),p.appendChild(u)}return r.appendChild(p),h&&this.handleRangeChange(h),r}},{key:"handleRangeChange",value:function(t){var e=t.parentNode;"any"===t.value?e.querySelector(".mt-filter-value-container").style.display="none":(e.querySelector(".mt-filter-value-container").style.display="inline-block","BETWEEN"===t.value?(e.querySelector(".mt-filter-value-min").style.display="inline-block",e.querySelector(".mt-filter-value-and").style.display="inline-block",e.querySelector(".mt-filter-value-max").style.display="inline-block"):(e.querySelector(".mt-filter-value-min").style.display="inline-block",e.querySelector(".mt-filter-value-and").style.display="none",e.querySelector(".mt-filter-value-max").style.display="none"))}},{key:"getPossibleFilters",value:function(t){var e=this;return Object.keys(this.maptable.columnDetails).map(function(t){return m.extendRecursive({key:t},e.maptable.columnDetails[t])}).filter(function(a){return-1!==e.activeColumns.indexOf(a.key)&&(t&&t===a.key||-1===e.criteria.indexOf(a.key)&&a.filterMethod&&!a.isVirtual)})}},{key:"filterData",value:function(){var t=this;this.maptable.data=this.maptable.rawData.filter(function(e){for(var a=document.querySelectorAll(".mt-filter-row"),i=!0,n=0;n<a.length&&i;n++){var r=a[n],s=r.getAttribute("data-mt-filter-name"),o=t.maptable.columnDetails[s],l=o.dataParse;if("dropdown"===o.filterMethod){var d=r.querySelector(".mt-filter-value").value;if(""===d)continue;e[s]!==d&&(i=!1)}else if("field"===o.filterMethod){var h=r.querySelector(".mt-filter-value").value;if(""===h)continue;-1===e[s].toLowerCase().indexOf(h.toLowerCase())&&(i=!1)}else if("compare"===o.filterMethod){var p=r.querySelector(".mt-filter-range").value;if("BETWEEN"===p){var c=r.querySelector(".mt-filter-value-min").value,u=r.querySelector(".mt-filter-value-max").value;if(""===c||""===u)continue;l&&(l(e[s])<l(c)||l(e[s])>l(u))?i=!1:(parseInt(e[s],10)<parseInt(c,10)||parseInt(e[s],10)>parseInt(u,10))&&(i=!1)}else{var f=r.querySelector(".mt-filter-value-min").value;if(""===f)continue;l&&!m.rangeToBool(l(e[s]),p,l(f))?i=!1:l||m.rangeToBool(e[s],p,f)||(i=!1)}}}return i})}},{key:"refresh",value:function(){for(var t=document.querySelectorAll(".mt-filter-name"),e=0;e<t.length;e++){var a=t[e],i=a.value,n=this.getPossibleFilters(i);a.innerHTML="",m.appendOptions(a,n.map(function(t){return{text:t.title,value:t.key}})),a.value=i}document.querySelectorAll(".mt-filters-and").length>0&&(document.querySelectorAll(".mt-filters-and")[0].style.visibility="hidden");var r=!this.getPossibleFilters().length;document.querySelector("#mt-filters-new").style.visibility=r?"hidden":"visible"}},{key:"toggle",value:function(){"none"===this.container.style.display?(this.container.style.display="block",0===this.criteria.length&&this.add()):this.container.style.display="none"}}]),t}(),C=function(){function t(e,a){var i=this;if(u.classCallCheck(this,t),this.maptable=e,this.options=a,this.currentSorting={key:Object.keys(this.maptable.data[0])[0],mode:"desc"},this.node=document.querySelector("#mt-table"),this.node||(this.node=document.createElement("div"),this.node.setAttribute("id","mt-table"),this.maptable.node.appendChild(this.node)),this.node=d3.select(this.node).append("table").attr("class",this.options.className),this.header=this.node.append("thead"),this.body=this.node.append("tbody"),this.options.show){var n=this.options.show.filter(function(t){return Object.keys(i.maptable.columnDetails).indexOf(t)<0});if(n.length>0)throw new Error('MapTable: invalid columns "'+n.join(", ")+'"');this.activeColumns=this.options.show}else this.activeColumns=Object.keys(this.maptable.columnDetails);this.header.selectAll("tr").data([1]).enter().append("tr").selectAll("th").data(this.activeColumns.map(function(t){return m.extendRecursive({key:t},i.maptable.columnDetails[t])})).enter().append("th").attr("class",function(t){var e=t.sorting?"mt-table-sortable":"";return e+=t.nowrap?" nowrap":""}).attr("style",function(t){return t.nowrap?"white-space:nowrap;":""}).text(function(t){return t.title}).attr("id",function(t){return"column_header_"+m.sanitizeKey(t.key)}).on("click",function(t){t.sorting&&i.sortColumn(t.key)}),this.options.defaultSorting?this.sortColumn(this.options.defaultSorting.key,this.options.defaultSorting.mode):this.render()}return u.createClass(t,[{key:"render",value:function(){var t=this;this.applySort(),this.body.selectAll("tr").data(this.maptable.data).enter().append("tr"),this.body.selectAll("tr").data(this.maptable.data).exit().remove();var e=[];this.body.selectAll("tr").data(this.maptable.data).attr("class",function(e){return t.options.rowClassName?"line "+t.options.rowClassName(e):"line"}).html(function(a){var i="";return t.activeColumns.forEach(function(n){var r=t.maptable.columnDetails[n];i+="<td",r.nowrap&&(i+=' style="white-space:nowrap;"'),i+=">",-1!==t.options.collapseRowsBy.indexOf(n)&&e[n]&&e[n]===a[n]||(r.cellContent?i+=r.cellContent(a):r.virtual?i+=r.virtual(a):a[n]&&"null"!==a[n]&&(i+=a[n]),-1!==t.options.collapseRowsBy.indexOf(n)&&(e[n]=a[n])),i+="</td>"}),i})}},{key:"applySort",value:function(){var t=this,e="asc"===this.currentSorting.mode?d3.ascending:d3.descending,a=this.maptable.columnDetails[this.currentSorting.key];this.maptable.data=this.maptable.data.sort(function(i,n){var r=i[t.currentSorting.key],s=n[t.currentSorting.key];return a.dataParse?(r=a.dataParse(r),s=a.dataParse(s)):a.virtual?(s=a.virtual(i),s=a.virtual(n)):"compare"===a.filterType?(r=parseInt(r,10),s=parseInt(s,10)):(r=r.toLowerCase(),s=s.toLowerCase()),e(r,s)})}},{key:"sortColumn",value:function(t,e){this.currentSorting.key=t,t===this.currentSorting.key?this.currentSorting.mode="asc"===this.currentSorting.mode?"desc":"asc":this.currentSorting.mode="asc";for(var a=document.querySelectorAll(".mt-table-sortable"),i=0;i<a.length;i++)a[i].setAttribute("class","mt-table-sortable");document.getElementById("column_header_"+m.sanitizeKey(t)).setAttribute("class","mt-table-sortable sort_"+this.currentSorting.mode),this.render()}}]),t}(),E=function(){function t(e,a){u.classCallCheck(this,t),this.options=a,this.node=document.querySelector(e),this.node.setAttribute("style","position:relative;"),"json"===this.options.data.type?d3.json(this.options.data.path,this.loadData.bind(this)):"csv"===this.options.data.type?d3.csv(this.options.data.path,this.loadData.bind(this)):"tsv"===this.options.data.type&&d3.tsv(this.options.data.path,this.loadData.bind(this)),this.options.map&&this.options.map.heatmap&&delete this.options.map.countries}return u.createClass(t,[{key:"loadData",value:function(t,e){var a=this;if(t)throw t;if(this.rawData=e,this.options.data.preFilter&&(this.rawData=this.rawData.filter(this.options.data.preFilter)),this.setColumnDetails(),this.data=this.rawData.slice(),this.options.map){var i=document.createElement("div");i.setAttribute("class","mt-map-container"),this.node.insertBefore(i,this.node.firstChild),d3.json(this.options.map.path,function(t,e){if(t)throw t;a.map=new x(a,a.options.map,e),a.render()})}this.options.filters&&(this.filters=new w(this,this.options.filters)),this.options.table&&(this.table=new C(this,this.options.table))}},{key:"render",value:function(){this.filters&&(this.filters.filterData(),this.filters.refresh()),this.map&&this.map.render(),this.table&&this.table.render()}},{key:"setColumnDetails",value:function(){var t=this;if(0!==t.rawData.length){var e={};Object.keys(t.rawData[0]).forEach(function(a){var i=/^\d+$/,n=i.test(t.rawData[0][a]);e[a]={title:m.keyToTile(a),filterMethod:n?"compare":"field",filterInputType:n?"number":"text",sorting:!0},n&&(e[a].dataParse=function(t){return parseInt(t,10)})}),t.columnDetails=m.extendRecursive(e,this.options.columns),Object.keys(t.columnDetails).forEach(function(e){t.columnDetails[e].isVirtual="function"==typeof t.columnDetails[e].virtual})}}}]),t}();if(d3.maptable=function(t){var e=void 0,a={},i={target:t,columns:{},data:{},map:null,filters:null,table:null};return a.map=function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(!topojson)throw new Error("Maptable requires topojson.js");if("string"!=typeof t.path)throw new Error("MapTable: map not provided");return i.map=t,a},a.json=function(t,e){return i.data.type="json",i.data.path=t,i.data.preFilter=e,a},a.csv=function(t,e){return i.data.type="csv",i.data.path=t,i.data.preFilter=e,a},a.tsv=function(t,e){return i.data.type="tsv",i.data.path=t,i.data.preFilter=e,a},a.filters=function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return i.filters=t,a},a.table=function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return i.table=t,a},a.columns=function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return i.columns=t,a},a.render=function(){if("string"!=typeof t||!document.querySelector(t))throw new Error("MapTable: target not found");if(!i.data||!i.data.path)throw new Error("MapTable: Please provide the path for your dataset json|csv|tsv");var a=m.extendRecursive(f,i);e=new E(t,a)},a},!d3)throw new Error("Maptable requires d3.js");var S=d3.maptable;return S}();