this.d3=this.d3||{},this.d3.maptable=function(){"use strict";function t(t,e,i){e.forEach(function(e){var i=document.createElement("option");i.setAttribute("value",e.value),i.innerText=e.text,t.appendChild(i)}),t.value=i}function e(t,e,i){return"="===e?parseInt(t,10)===parseInt(i,10):"≠"===e?parseInt(t,10)!==parseInt(i,10)&&""!==t&&""!==i:">"===e?parseInt(t,10)>parseInt(i,10)&&""!==t&&""!==i:"<"===e?parseInt(t,10)<parseInt(i,10)&&""!==t&&""!==i:"≥"===e?parseInt(t,10)>=parseInt(i,10)&&""!==t&&""!==i:"≤"===e?parseInt(t,10)<=parseInt(i,10)&&""!==t&&""!==i:!0}function i(t,e){return t||(t={}),e||(e={}),Object.keys(e).forEach(function(a){try{e[a].constructor===Object?t[a]=i(t[a],e[a]):t[a]=e[a]}catch(n){t[a]=e[a]}}),t}function a(t){var e=t.charAt(0).toUpperCase()+t.slice(1);return e.replace(/_/g," ")}function n(t){return t.toLowerCase().replace(/ /g,"_").replace(/"/g,"").replace(/'/g,"")}var r={};r["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},r.classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},r.createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,i,a){return i&&t(e.prototype,i),a&&t(e,a),e}}();var s={rangeToBool:e,appendOptions:t,extendRecursive:i,sanitizeKey:n,keyToTile:a},o={map:{longitudeKey:"longitude",latitudeKey:"latitude",zoom:!0,legend:!1,ratioFromWidth:.5,scaleHeight:1,scaleZoom:[1,10],fitContentMargin:10,autoFitContent:!0,tooltipClass:"popover bottom",title:{fontSize:12,fontFamily:"Helevetica, Arial, Sans-Serif"}},table:{"class":"table table-striped table-bordered",collapseRowsBy:[]}},l=function(){function t(e){r.classCallCheck(this,t),this.map=e,this.node=this.map.svg.append("g").attr("id","mt-map-legend").attr("transform","translate("+(this.map.getWidth()-300)+", "+(this.map.getHeight()-60)+")"),this.buildScale(),this.buildIndice()}return r.createClass(t,[{key:"buildScale",value:function(){var t=this.node.append("defs").append("linearGradient").attr("id","mt-map-legend-gradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%");t.append("stop").attr("offset","0%").attr("style","stop-color:"+this.map.options.countries.attr.fill.min+";stop-opacity:1"),t.append("stop").attr("offset","100%").attr("style","stop-color:"+this.map.options.countries.attr.fill.max+";stop-opacity:1"),this.node.append("rect").attr("x",40).attr("y",0).attr("width",220).attr("height",15).attr("fill","url(#mt-map-legend-gradient)")}},{key:"buildIndice",value:function(){var t=this.node.append("g").attr("id","mt-map-legend-indice").attr("style","display:none").attr("transform","translate(36,15)");t.append("polygon").attr("points","4.5 0 9 5 0 5").attr("fill","#222222"),t.append("text").attr("x",4).attr("y",13).attr("width",10).attr("height",10).attr("text-anchor","middle").attr("font-family","Arial").attr("font-size","9").attr("stroke","#FFFFF").attr("stroke-width","1").attr("fill","#222222").text("0"),this.node.append("text").attr("id","mt-map-legend-min").attr("x",35).attr("y",13).attr("width",35).attr("height",15).attr("text-anchor","end").attr("font-family","Arial").attr("font-size","14").attr("stroke","#FFFFF").attr("stroke-width","3").attr("fill","#222222").text("0"),this.node.append("text").attr("id","mt-map-legend-max").attr("y",13).attr("x",265).attr("width",40).attr("height",15).attr("text-anchor","start").attr("font-family","Arial").attr("font-size","14").attr("stroke","#FFFFF").attr("stroke-width","3").attr("fill","#222222").text("1")}},{key:"updateExtents",value:function(t){document.getElementById("mt-map-legend").style.opacity=t[0]===t[1]?0:1,document.getElementById("mt-map-legend-min")&&(this.node.select("#mt-map-legend-min").text(t[0]),this.node.select("#mt-map-legend-max").text(t[1]))}},{key:"indiceChange",value:function(t){if(isNaN(t))this.node.select("#mt-map-legend-indice").attr("style","display:none");else{var e=parseInt(this.node.select("#mt-map-legend-max").text(),10),i=t/e*220;this.node.select("#mt-map-legend-indice text").text(t),this.node.select("#mt-map-legend-indice").attr("style","display:block").attr("transform","translate("+(36+i)+",15)")}}}]),t}(),d=function(){function t(e,i){return r.classCallCheck(this,t),this.map=e,this.src=i.src,this.position=i.position,this.width=parseInt(i.width,10),this.height=parseInt(i.height,10),this.padding=i.padding||10,this.style=i.style,i.src?isNaN(this.width)?void console.warn("Watermak width not found"):isNaN(this.height)?void console.warn("Watermak height not found"):void(window.btoa?this.buildWatermark():console.warn("Watermark not rendered: btoa error")):void console.warn("Watermak src not found")}return r.createClass(t,[{key:"buildWatermark",value:function(){var t=this;d3.xhr(this.src,function(e){var i=0;t.map.options.title&&(i=30);var a=void 0,n=void 0,r=void 0;if(-1!==t.src.indexOf(".svg"))a="image/svg+xml";else if(-1!==t.src.indexOf(".jpg")||-1!==t.src.indexOf(".jpeg"))a="image/jpeg";else{if(-1===t.src.indexOf(".png"))return void console.warn("invalid watermark mime type");a="image/png"}var s="data:"+a+";base64,"+window.btoa(e.responseText);if(t.position){var o=t.position.split(" ");"top"===o[0]?r=t.padding:"middle"===o[0]?r=(t.map.getHeight()-t.height)/2:"bottom"===o[0]?r=t.map.getHeight()-t.height-t.padding-i:console.warn("position should be (top|middle|bottom) (left|middle|right)"),"left"===o[1]?n=t.padding:"middle"===o[1]?n=(t.map.getWidth()-t.width)/2:"right"===o[1]?n=t.map.getWidth()-t.width-t.padding:console.warn("position should be (top|middle|bottom) (left|middle|right)")}t.node=t.map.svg.append("image").attr("xlink:href",s).attr("width",t.width).attr("height",t.height),n&&r&&t.node.attr("x",n).attr("y",r),t.style&&t.node.attr("style",t.style)})}}]),t}(),p=function(){function t(e,i,a){r.classCallCheck(this,t);var n=this;this.maptable=e,this.scale=1,this.transX=0,this.transY=0,this.options=i,this.jsonWorld=a,this.node=document.querySelector("#mt-map"),this.node||(this.node=document.createElement("div"),this.node.setAttribute("class","mt-map"),this.maptable.node.insertBefore(this.node,this.maptable.node.firstChild)),this.svg=d3.select(this.node).append("svg").attr("id","mt-map-svg").attr("viewBox","0 0 "+this.getWidth()+" "+this.getHeight()).attr("width",this.getWidth()).attr("height",this.getHeight()),d3.select(this.node).attr("style","height:"+this.getHeight()+"px"),this.projection=d3.geo.equirectangular().translate([this.getWidth()/2,this.getHeight()/(2*this.options.scaleHeight)]).scale(this.getWidth()/640*100).rotate([-12,0]).precision(.1),this.maptable.rawData.forEach(function(t){t.longitude=parseFloat(t[n.options.longitudeKey]),t.latitude=parseFloat(t[n.options.latitudeKey]);var e=n.projection([t.longitude,t.latitude]);return t.x=e[0],t.y=e[1],t}),this.zoomListener=d3.behavior.zoom().scaleExtent(this.options.scaleZoom).on("zoom",this.rescale.bind(this)),this.options.zoom&&(this.svg=this.svg.call(this.zoomListener.bind(this))),this.tooltipNode=d3.select(this.node).append("div").attr("class","mt-map-tooltip "+this.options.tooltipClass).style("display","none"),this.layerGlobal=this.svg.append("g").attr("class","mt-map-global"),this.layerCountries=this.layerGlobal.append("g").attr("class","mt-map-countries"),this.layerMarkers=this.layerGlobal.append("g").attr("class","mt-map-markers"),this.loadGeometries(),this.options.watermark&&(this.watermark=new d(this,this.options.watermark)),this.options.title&&this.buildTitle(),this.options.exportSvg&&this.addExportSvgCapability()}return r.createClass(t,[{key:"scaleAttributes",value:function(){return Math.pow(this.scale,2/3)}},{key:"getWidth",value:function(){return this.options.width?this.options.width:this.node.offsetWidth}},{key:"getHeight",value:function(){var t=this.options.title?30:0;return!this.options.height&&this.options.ratioFromWidth?this.getWidth()*this.options.ratioFromWidth*this.options.scaleHeight+t:this.options.height*this.options.scaleHeight+t}},{key:"loadGeometries",value:function(){var t=topojson.feature(this.jsonWorld,this.jsonWorld.objects.countries).features,e=[],i={};this.options.countries.groupBy&&(e=d3.nest().key(this.options.countries.groupBy).entries(this.maptable.data),i={},e.forEach(function(t){i[t.key]=e.values}));for(var a=0;a<t.length;a++)t[a].key=t[a].id,t[a].values=[];this.layerCountries.selectAll(".mt-map-country").data(t).enter().insert("path").attr("class","mt-map-country").attr("d",d3.geo.path().projection(this.projection)),this.legendObject&&this.options.countries.attr.fill.min&&this.options.countries.attr.fill.max&&(this.legendObject=new l(this)),this.updateCountries(),this.updateMarkers()}},{key:"fitContent",value:function(){if(0===this.maptable.data.length)return this.transX=0,this.transY=0,this.scale=1,this.zoomListener.translate([this.transX,this.transY]).scale(this.scale),!0;var t=d3.extent(this.maptable.data,function(t){return t.x}),e=d3.extent(this.maptable.data,function(t){return t.y}),i=this.getWidth()/this.getHeight(),a=20+(this.options.title?30:0),n=t[1]-t[0]+a,r=e[1]-e[0]+a,s=n/i,o=r*i,l=0,d=0;o>=n?l=(o-n)/2:d=(s-r)/2,t[0]-=this.options.fitContentMargin+l,t[1]+=this.options.fitContentMargin+l,e[0]-=this.options.fitContentMargin+d,e[1]+=this.options.fitContentMargin+d,this.scale=this.getWidth()/(t[1]-t[0]),this.transX=-1*t[0]*this.scale,this.transY=-1*e[0]*this.scale,this.zoomListener.translate([this.transX,this.transY]).scale(this.scale)}},{key:"buildTitle",value:function(){var t=this.svg.append("svg").attr("width",this.getWidth()).attr("x",0).attr("y",this.getHeight()-30).attr("height",30);this.options.title.bgColor&&t.append("rect").attr("x",0).attr("y",0).attr("width",this.getWidth()).attr("height",30).attr("fill",this.options.title.bgColor),t.append("text").attr("id","mt-map-title").attr("x",20).attr("font-size",this.options.title.fontSize).attr("font-family",this.options.title.fontFamily).attr("y",20),this.options.title.source&&t.append("text").attr("y",20).attr("x",this.getWidth()-20).attr("text-anchor","end").attr("font-size",this.options.title.fontSize).attr("font-family",this.options.title.fontFamily).html(this.options.title.source())}},{key:"rescale",value:function(){var t=this;d3.event&&d3.event.translate&&(this.scale=d3.event.scale,this.transX=1===this.scale?0:d3.event.translate[0],this.transY=1===this.scale?0:d3.event.translate[1]);var e=0,i=0,a=this.getWidth()*(1-this.scale),n=this.getHeight()*(1-this.scale);this.transY>i?this.transY=i:this.transY<n&&(this.transY=n),this.transX>e?this.transX=e:this.transX<a&&(this.transX=a),d3.event&&d3.event.translate&&(d3.event.translate[0]=this.transX,d3.event.translate[1]=this.transY),this.layerGlobal.attr("transform","translate("+this.transX+", "+this.transY+")scale("+this.scale+")"),t.tooltipNode.attr("style","display:none;"),this.options.markers&&d3.selectAll(".mt-map-marker").each(function(e){e.prop["stroke-width"]&&d3.select(this).attr("stroke-width",e.prop["stroke-width"]/t.scaleAttributes()),e.prop.r&&d3.select(this).attr("r",e.prop.r/t.scaleAttributes())}),d3.selectAll(".mt-map-country").each(function(e){e.prop["stroke-width"]&&d3.select(this).attr("stroke-width",e.prop["stroke-width"]/t.scaleAttributes())})}},{key:"getScaledValue",value:function(t,e,i,a){if("object"===r["typeof"](t.attr[e])){if(!t.rollup)throw new Error("MaptTable: rollup property is not defined for "+e);var n=Object.assign({},t.attr[e]);if(!n.min||!n.max)throw new Error("MaptTable: You should provide values for 'min' and 'max' for "+e);var s=d3.extent(a,function(e){return t.rollup(e.values)});"minValue"===n.min&&(n.min=s[0]),"maxValue"===n.max&&(n.max=s[1]),"function"==typeof n.transform&&(n.min=n.transform(n.min),n.max=n.transform(n.max));var o=d3.scale.linear().domain(s).range([n.min,n.max]),l=a.filter(function(t){return t.key===i.key});if(!l.length){if("undefined"!=typeof n.empty)return n.empty;throw new Error("MapTable: no empty property found for "+e)}return i.value=t.rollup(l[0].values),o(i.value)}if("number"==typeof t.attr[e]||"string"==typeof t.attr[e])return t.attr[e];throw new Error("Maptable: Invalid value for "+e)}},{key:"updateMarkers",value:function(){var t=this,e=function(t){return t.longitude+","+t.latitude},i=d3.nest().key(this.options.markers.groupBy?this.options.markers.groupBy:e).entries(this.maptable.data).filter(function(t){return 0!==t.values[0].latitude}),a=this.layerMarkers.selectAll(".mt-map-marker").data(i);a.exit().transition().attr("r",0).attr("fill","#eee").style("opacity",0).remove();var n=a.enter();n=this.options.markers.customMarker?this.options.markers.customMarker(n):n.append("svg:circle");var r=this.options.markers.className?this.options.markers.className:"";n.attr("class","mt-map-marker "+r);var s=this.options.markers.attrX?this.options.markers.attrX:"cx",o=this.options.markers.attrY?this.options.markers.attrY:"cy",l=this.options.markers.attrXDelta?this.options.markers.attrXDelta:0,d=this.options.markers.attrYDelta?this.options.markers.attrYDelta:0,p=a.attr(s,function(t){return t.values[0].x+l}).attr(o,function(t){return t.values[0].y+d});this.options.markers.attr&&Object.keys(this.options.markers.attr).forEach(function(e){p=p.attr(e,function(a){return a.prop||(a.prop={}),a.prop[e]=t.getScaledValue(t.options.markers,e,a,i),a.prop[e]})}),this.options.markers.tooltip&&this.activateTooltip(p,this.options.markers.tooltip)}},{key:"updateCountries",value:function(){var t=this,e=this;this.options.countries.attr&&!function(){var i=[],a={};if(t.options.countries.groupBy){i=d3.nest().key(t.options.countries.groupBy).entries(t.maptable.data);for(var n=0;n<i.length;n++)a[i[n].key]=i[n].values}var r=d3.selectAll(".mt-map-country").each(function(t){var a=this;Object.keys(e.options.countries.attr).forEach(function(n){d3.select(a).attr(n,function(){return t.prop||(t.prop={}),t.prop[n]=e.getScaledValue(e.options.countries,n,t,i),t.prop[n]})})});if(t.legendObject&&t.options.countries.attr.fill.min&&t.options.countries.attr.fill.max){var s=d3.extent(i,function(e){return t.options.countries.rollup(e.values)});t.legendObject.updateExtents(s),r.on("mouseover",function(e){return t.legendObject.indiceChange(e.value)}).on("mouseout",function(){return t.legendObject.indiceChange(NaN)})}t.options.countries.tooltip&&t.activateTooltip(r,t.options.countries.tooltip)}()}},{key:"render",value:function(){this.updateMarkers(),this.updateCountries(),this.updateTitle(),this.fitContent(),this.rescale()}},{key:"updateTitle",value:function(){var t=this;if(this.options.title.content){var e=this.maptable.data.filter(function(e){return 0!==e[t.options.latitudeKey]}).length,i=this.maptable.rawData.filter(function(e){return 0!==e[t.options.latitudeKey]}).length,a="";this.maptable.filters&&(a=this.maptable.filters.getDescription()),document.getElementById("mt-map-title").innerHTML=this.options.title.content(e,i,a)}}},{key:"activateTooltip",value:function(t,e,i){var a=this;t.on("mousemove",function(t){var n=d3.mouse(a.svg.node()).map(function(t){return parseInt(t,10)});a.tooltipNode.attr("style","display:block;").html(e(t));var r=a.tooltipNode.node().offsetWidth/2,s=n[0]-r,o=n[1]+10+document.getElementById("mt-map").offsetTop;a.tooltipNode.attr("style","top:"+o+"px;left:"+s+"px;display:block;").on("mouseout",function(){return a.tooltipNode.style("display","none")}),i&&a.tooltipNode.on("click",i)}).on("mouseout",function(){return a.tooltipNode.style("display","none")})}},{key:"exportSvg",value:function(){var t=document.getElementById("mt-map-svg"),e=(new XMLSerializer).serializeToString(t),i=document.getElementById("mt-map-svg-form");i.querySelector('[name="data"]').value=e,i.submit()}},{key:"addExportSvgCapability",value:function(){var t=document.createElement("div");t.setAttribute("id","mt-map-export"),document.getElementById("mt-map").appendChild(t);var e=document.createElement("button");e.setAttribute("class","btn btn-xs btn-default"),e.innerHTML='<i class="glyphicon glyphicon-download-alt"></i> Download',e.addEventListener("click",this.exportSvg.bind(this)),t.appendChild(e);var i=document.createElement("div");i.innerHTML='<form id="mt-map-svg-form" method="post"\n      action="'+this.options.exportSvg+'"><input type="hidden" name="data"></form>',t.appendChild(i)}}]),t}(),h=function(){function t(e,i){var a=this;if(r.classCallCheck(this,t),this.maptable=e,this.options=i,this.criteria=[],this.options.show){var n=this.options.show.filter(function(t){return Object.keys(a.maptable.columnDetails).indexOf(t)<0});if(n.length>0)throw new Error('MapTable: invalid columns "'+n.join(", ")+'"');this.activeColumns=this.options.show}else this.activeColumns=Object.keys(this.maptable.columnDetails);this.container=document.createElement("div"),this.maptable.node.appendChild(this.container),this.node=document.querySelector("#mt-filters"),this.node||(this.node=document.createElement("div"),this.node.setAttribute("class","mt-filters"),this.node.setAttribute("class","panel panel-default"),this.maptable.node.appendChild(this.node));var s=document.createElement("div");s.setAttribute("class","panel-heading");var o=document.createElement("button");o.setAttribute("id","mt-filters-reset"),o.setAttribute("class","btn btn-default btn-xs pull-right"),o.style.display="none",o.style.marginLeft=5,o.innerText="↺ Reset",o.addEventListener("click",this.reset),s.appendChild(o);var l=document.createElement("h3");l.setAttribute("class","panel-title"),l.appendChild(document.createTextNode("Filters")),s.appendChild(l),this.node.appendChild(s);var d=document.createElement("div");d.setAttribute("id","mt-filters-content"),d.setAttribute("class","panel-body");var p=document.createElement("div");p.setAttribute("id","mt-filters-elements"),d.appendChild(p);var h=document.createElement("a");h.setAttribute("id","mt-filters-new"),h.setAttribute("href","#"),h.innerText="+ New filter",h.addEventListener("click",this.add.bind(this)),d.appendChild(h),this.node.appendChild(d)}return r.createClass(t,[{key:"add",value:function(){var t=this.getPossibleFilters();if(0!==t.length){var e=t[0].key;this.create(e)}}},{key:"create",value:function(t,e){var i=this.buildRow(t);e?e.parentNode.replaceChild(i,e):document.querySelector("#mt-filters-elements").appendChild(i),this.criteria.push(t),this.maptable.render(),"none"===this.container.style.display&&this.toggle()}},{key:"remove",value:function(t){var e=document.querySelector('[data-mt-filter-name="'+t+'"]');e&&e.remove();var i=this.criteria.indexOf(t);this.criteria.splice(i,1),this.maptable.render()}},{key:"reset",value:function(){this.criteria=[],this.container.innerHTML="",this.refresh(),this.maptable.map.reset()}},{key:"getDescription",value:function(){for(var t=[],e=document.querySelector("#mt-filters-elements").childNodes,i=0;i<e.length;i++){var a=e[i],n=a.querySelector(".mt-filter-name").value,r=this.maptable.columnDetails[n],s="";if("number"===r.type||"custom"===r.type){var o=a.querySelector(".mt-filter-range");if("any"!==o.value)if("BETWEEN"===o.value){var l=a.querySelector(".mt-filter-value-min").value,d=a.querySelector(".mt-filter-value-max").value;if(""===l||""===d)continue;s+=r.title+" is between ",s+='<tspan font-weight="bold">'+l+'</tspan> and\n              <tspan font-weight="bold">'+d+"</tspan>"}else{var p=a.querySelector(".mt-filter-value").value;if(""===p)continue;s+=r.title+" is ",s+=o.options[o.selectedIndex].text,s+='<tspan font-weight="bold">'+p+"</tspan>"}}else if("field"===r.type||"dropdown"===r.type){var h=a.querySelector(".mt-filter-value").value;if(""===h)continue;var u="field"===r.type?"contains":"is";s+=r.title+" "+u+'\n          <tspan font-weight="bold">'+h+"</tspan>"}t.push(s)}return t.join(", ")}},{key:"buildRow",value:function(t){var e=this,i=this,a=this.getPossibleFilters(),n=this.maptable.columnDetails[t],r=document.createElement("div");r.setAttribute("class","mt-filter-row"),r.setAttribute("data-mt-filter-name",t);var o=document.createElement("button");o.setAttribute("class","btn btn-default pull-right"),o.setAttribute("data-mt-filter-btn-minus",1),o.innerText="– Remove this filter",o.addEventListener("click",function(){t=r.querySelector(".mt-filter-name").value,e.remove(t)}),r.appendChild(o);var l=document.createElement("span");l.setAttribute("class","mt-filters-and"),l.innerText="And ",r.appendChild(l);var d=document.createElement("select");d.setAttribute("class","mt-filter-name form-control form-control-inline"),s.appendOptions(d,a.map(function(t){return{text:t.title,value:t.key}})),d.value=t,d.addEventListener("change",function(){var t=this.parentNode.getAttribute("data-mt-filter-name"),e=this.value;i.create(e,this.parentNode),i.remove(t),i.refresh()}),r.appendChild(d);var p=document.createElement("span");p.innerText="field"===n.type?" contains ":" is ",r.appendChild(p);var h=null;"field"!==n.type&&"dropdown"!==n.type&&(h=document.createElement("select"),h.setAttribute("class","mt-filter-range form-control form-control-inline"),s.appendOptions(h,["any","=","≠","<",">","≤","≥","BETWEEN"].map(function(t){return{text:t,value:t}})),h.addEventListener("change",function(){i.handleRangeChange(this)}),r.appendChild(h),r.appendChild(document.createTextNode(" ")));var u=document.createElement("div");if(u.style.display="inline-block",u.setAttribute("class","mt-filter-value-container"),"number"===n.type||"custom"===n.type)["min","max"].forEach(function(t,i){var a=document.createElement("input");if(a.setAttribute("class","form-control form-control-inline mt-filter-value-"+t),n.type?a.setAttribute("type",n.type):a.setAttribute("type","text"),a.addEventListener("keyup",e.maptable.render.bind(e.maptable)),a.addEventListener("change",e.maptable.render.bind(e.maptable)),u.appendChild(a),0===i){var r=document.createElement("span");r.setAttribute("class","mt-filter-value-and"),r.innerText=" and ",u.appendChild(r)}});else if("field"===n.type){var c=document.createElement("input");c.setAttribute("class","form-control form-control-inline mt-filter-value"),c.setAttribute("type","text"),c.addEventListener("keyup",this.maptable.render.bind(this.maptable)),c.addEventListener("change",this.maptable.render.bind(this.maptable)),u.appendChild(c)}else if("dropdown"===n.type){var m=document.createElement("select");m.setAttribute("class","form-control form-control-inline mt-filter-value");var f=d3.nest().key(function(e){return e[t]}).sortKeys(d3.ascending).entries(this.maptable.rawData);s.appendOptions(m,[{text:"Any",value:""}].concat(f.map(function(t){return{text:t.key,value:t.key}}))),m.addEventListener("change",this.maptable.render.bind(this.maptable)),u.appendChild(m)}return r.appendChild(u),h&&this.handleRangeChange(h),r}},{key:"handleRangeChange",value:function(t){var e=t.parentNode;"any"===t.value?e.querySelector(".mt-filter-value-container").style.display="none":(e.querySelector(".mt-filter-value-container").style.display="inline-block","BETWEEN"===t.value?(e.querySelector(".mt-filter-value-min").style.display="inline-block",e.querySelector(".mt-filter-value-max").style.display="inline-block"):(e.querySelector(".mt-filter-value-max").style.display="none",e.querySelector(".mt-filter-value-and").style.display="none"))}},{key:"getPossibleFilters",value:function(t){var e=this;return Object.keys(this.maptable.columnDetails).map(function(t){return Object.assign({key:t},e.maptable.columnDetails[t])}).filter(function(i){return-1!==e.activeColumns.indexOf(i.key)&&(t&&t===i.key||-1===e.criteria.indexOf(i.key)&&i.type&&"virtual"!==i.type)})}},{key:"filterData",value:function(){var t=this;this.maptable.data=this.maptable.rawData.filter(function(e){for(var i=document.querySelectorAll(".mt-filter-row"),a=0;a<i.length;a++){var n=i[a],r=n.getAttribute("data-mt-filter-name"),o=t.maptable.columnDetails[r],l=o.dataFormat;if("dropdown"===o.type){var d=n.querySelector(".mt-filter-value").value;if(""===d)continue;if(e[r]!==d)return!1}else{if("field"===o.type){var p=n.querySelector(".mt-filter-value").value;if(""===p)continue;return-1!==e[r].toLowerCase().indexOf(p.toLowerCase())}if("number"===o.type||"custom"===o.type){var h=n.querySelector(".mt-filter-range").value;if("BETWEEN"===h){var u=n.querySelector(".mt-filter-value-min").value,c=n.querySelector(".mt-filter-value-max").value;if(""===u||""===c)continue;if("custom"===o.type&&l){if(l&&(l(e[r])<l(u)||l(e[r])>l(c)))return!1}else if(parseInt(e[r],10)<parseInt(u,10)||parseInt(e[r],10)>parseInt(c,10))return!1}else{var m=n.querySelector(".mt-filter-value").value;if(""===m)continue;if("custom"===o.type&&l){if(!s.rangeToBool(l(e[r]),h,l(m)))return!1}else if(!s.rangeToBool(e[r],h,m))return!1}}}}return!0})}},{key:"refresh",value:function(){for(var t=document.querySelectorAll(".mt-filter-name"),e=0;e<t.length;e++){var i=t[e],a=i.value,n=this.getPossibleFilters(a);i.innerHTML="",s.appendOptions(i,n.map(function(t){return{text:t.title,value:t.key}})),i.value=a}document.querySelectorAll(".mt-filters-and").length>0&&(document.querySelectorAll(".mt-filters-and")[0].style.visibility="hidden");var r=!this.getPossibleFilters().length;document.querySelector("#mt-filters-new").style.visibility=r?"hidden":"visible"}},{key:"toggle",value:function(){"none"===this.container.style.display?(this.container.style.display="block",0===this.criteria.length&&this.add()):this.container.style.display="none"}}]),t}(),u=function(){function t(e,i){var a=this;if(r.classCallCheck(this,t),this.maptable=e,this.options=i,this.currentSorting={key:null,mode:"desc"},this.node=document.querySelector("#mt-table"),this.node||(this.node=document.createElement("div"),this.node.setAttribute("id","mt-table"),this.maptable.node.appendChild(this.node)),this.node=d3.select(this.node).append("table").attr("class",this.options.className),this.header=this.node.append("thead"),this.body=this.node.append("tbody"),this.options.show){var n=this.options.show.filter(function(t){return Object.keys(a.maptable.columnDetails).indexOf(t)<0});if(n.length>0)throw new Error('MapTable: invalid columns "'+n.join(", ")+'"');this.activeColumns=this.options.show}else this.activeColumns=Object.keys(this.maptable.columnDetails);this.header.selectAll("tr").data([1]).enter().append("tr").selectAll("th").data(this.activeColumns.map(function(t){return Object.assign({key:t},a.maptable.columnDetails[t])})).enter().append("th").attr("class",function(t){var e=t.sorting?"mt-table-sortable":"";return e+=t.nowrap?" nowrap":""}).attr("style",function(t){return t.nowrap?"white-space:nowrap;":""}).text(function(t){return t.title}).attr("id",function(t){return"column_header_"+s.sanitizeKey(t.key)}).on("click",function(t){t.sorting&&a.sortColumn(t.key)}),this.options.defaultSorting?this.sortColumn(this.options.defaultSorting.key,this.options.defaultSorting.mode):this.render()}return r.createClass(t,[{key:"render",value:function(){var t=this;this.applySort(),this.body.selectAll("tr").data(this.maptable.data).enter().append("tr"),this.body.selectAll("tr").data(this.maptable.data).exit().remove();var e=[];this.body.selectAll("tr").data(this.maptable.data).attr("class",function(e){return t.options.rowClassName?"line "+t.options.rowClassName(e):"line"}).html(function(i){var a="";return t.activeColumns.forEach(function(n){var r=t.maptable.columnDetails[n];a+="<td",r.nowrap&&(a+=' style="white-space:nowrap;"'),a+=">",-1!==t.options.collapseRowsBy.indexOf(n)&&e[n]&&e[n]===i[n]||("function"==typeof r.cellContent?a+=r.cellContent(i):i[n]&&"null"!==i[n]&&(a+=i[n]),-1!==t.options.collapseRowsBy.indexOf(n)&&(e[n]=i[n])),a+="</td>"}),a})}},{key:"applySort",value:function(){var t=this,e="asc"===this.currentSorting.mode?d3.ascending:d3.descending,i=this.maptable.columnDetails[this.currentSorting.key];this.maptable.data=this.maptable.data.sort(function(a,n){var r=a[t.currentSorting.key],s=n[t.currentSorting.key];return"virtual"===i.type&&i.cellContent?(s=i.cellContent(a),s=i.cellContent(n)):"number"===i.type?(r=parseInt(r,10),s=parseInt(s,10)):i.dataFormat?(r=i.dataFormat(r),s=i.dataFormat(s)):(r=r.toLowerCase(),s=s.toLowerCase()),e(r,s)})}},{key:"sortColumn",value:function(t,e){this.currentSorting.key=t,t===this.currentSorting.key?this.currentSorting.mode="asc"===this.currentSorting.mode?"desc":"asc":e?this.currentSorting.mode=e:this.currentSorting.mode="asc";for(var i=document.querySelectorAll(".mt-table-sortable"),a=0;a<i.length;a++)i[a].setAttribute("class","mt-table-sortable");document.getElementById("column_header_"+s.sanitizeKey(t)).setAttribute("class","mt-table-sortable sort_"+this.currentSorting.mode),this.render()}}]),t}(),c=function(){function t(e,i){r.classCallCheck(this,t),this.options=i,this.node=document.querySelector(e),"json"===this.options.data.type?d3.json(this.options.data.path,this.loadData.bind(this)):"csv"===this.options.data.type?d3.csv(this.options.data.path,this.loadData.bind(this)):"tsv"===this.options.data.type&&d3.tsv(this.options.data.path,this.loadData.bind(this))}return r.createClass(t,[{key:"loadData",value:function(t,e){var i=this;if(t)throw t;this.rawData=e,this.setColumnDetails(),this.data=e.slice(),this.options.map&&d3.json(this.options.map.path,function(t,e){if(t)throw t;i.map=new p(i,i.options.map,e),i.render()}),this.options.filters&&(this.filters=new h(this,this.options.filters)),this.options.table&&(this.table=new u(this,this.options.table))}},{key:"render",value:function(){this.filters&&(this.filters.filterData(),this.filters.refresh()),this.map&&this.map.render(),this.table&&this.table.render()}},{key:"setColumnDetails",value:function(){var t=this;if(0!==t.rawData.length){var e={};Object.keys(t.rawData[0]).forEach(function(i){var a="field",n=/^\d+$/;n.test(t.rawData[0][i])&&(a="number"),e[i]={title:s.keyToTile(i),type:a,sorting:!0}}),t.columnDetails=s.extendRecursive(e,this.options.columns)}}}]),t}();if(d3.maptable=function(t){var e=void 0,i={},a={target:t,columns:{},data:{},map:null,filters:null,table:null};return i.map=function(t){if(!topojson)throw new Error("Maptable requires topojson.js");if("string"!=typeof t.path)throw new Error("MapTable: map not provided");return a.map=t,i},i.json=function(t){return a.data.type="json",a.data.path=t,i},i.csv=function(t){return a.data.type="csv",a.data.path=t,i},i.tsv=function(t){return a.data.type="tsv",a.data.path=t,i},i.filters=function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return a.filters=t,i},i.table=function(t){return a.table=t,i},i.columns=function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return a.columns=t,i},i.render=function(){if("string"!=typeof t||!document.querySelector(t))throw new Error("MapTable: target not found");if(!a.data||!a.data.path)throw new Error("MapTable: Please provide the path for your dataset json|csv|tsv");var i=s.extendRecursive(o,a);e=new c(t,i)},i},!d3)throw new Error("Maptable requires d3.js");var m=d3.maptable;return m}();