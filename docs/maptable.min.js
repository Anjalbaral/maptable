/**
 * MapTable 1.7.2 - License MIT - Build: Fri Nov 16 2018 14:00:18 GMT-0800 (PST)
 */

this.d3=this.d3||{},this.d3.maptable=function(){"use strict";function t(t,e,i){e.forEach(function(e){var i=document.createElement("option");i.setAttribute("value",e.value),i.innerText=e.text,t.appendChild(i)}),t.value=i}function e(t,e,i){return"="===e?parseInt(t,10)===parseInt(i,10):"≠"===e?parseInt(t,10)!==parseInt(i,10)&&""!==t&&""!==i:">"===e?parseInt(t,10)>parseInt(i,10)&&""!==t&&""!==i:"<"===e?parseInt(t,10)<parseInt(i,10)&&""!==t&&""!==i:"≥"===e?parseInt(t,10)>=parseInt(i,10)&&""!==t&&""!==i:"≤"===e?parseInt(t,10)<=parseInt(i,10)&&""!==t&&""!==i:!0}function i(){for(var t={},e=void 0,a=[].splice.call(arguments,0),n={}.toString;a.length>0;)e=a.splice(0,1)[0],"[object Object]"===n.call(e)&&Object.keys(e).forEach(function(a){"[object Object]"===n.call(e[a])?t[a]=i(t[a]||{},e[a]):t[a]=e[a]});return t}function a(t){var e=t.charAt(0).toUpperCase()+t.slice(1);return e.replace(/_/g," ")}function n(t){return t.toLowerCase().replace(/ /g,"_").replace(/"/g,"").replace(/'/g,"")}function r(t){return t&&""!==t?Number(t.toString().replace(/[^0-9.]+|\s+/gim,"")):null}function s(t,e){t.sort(function(t,e){return t-e});var i=e/100*(t.length-1),a=void 0;if(Math.floor(i)===i)a=t[i];else{var n=Math.floor(i),r=i-n;a=t[n]+(t[n+1]-t[n])*r}return a}function o(t){if(!t)return t;for(var e=[],i=0,a=t.length;a>i;i+=1)-1===e.indexOf(t[i])&&""!==t[i]&&e.push(t[i]);return e}function l(t,e,i,a){if("string"==typeof t)var t=document.getElementById(t);else if("undefined"!=typeof HTMLImageElement&&!t instanceof HTMLImageElement)return;var n=t.naturalWidth,r=t.naturalHeight;if("string"==typeof e)var e=document.getElementById(e);else if("undefined"!=typeof HTMLCanvasElement&&!e instanceof HTMLCanvasElement)return;e.style.width=n+"px",e.style.height=r+"px",e.width=n,e.height=r;var s=e.getContext("2d");s.clearRect(0,0,n,r),s.drawImage(t,0,0),Number.isNaN(i)||1>i||(a?u(e,0,0,n,r,i):p(e,0,0,n,r,i))}function h(t,e,i,a,n){if("string"==typeof t)var t=document.getElementById(t);else if("undefined"!=typeof HTMLCanvasElement&&!t instanceof HTMLCanvasElement)return;var r,s=t.getContext("2d");try{try{r=s.getImageData(e,i,a,n)}catch(o){throw new Error("unable to access local image data: "+o)}}catch(o){throw new Error("unable to access image data: "+o)}return r}function u(t,e,i,a,n,r){if(!(Number.isNaN(r)||1>r)){r|=0;var s=h(t,e,i,a,n);s=d(s,e,i,a,n,r),t.getContext("2d").putImageData(s,e,i)}}function d(t,e,i,a,n,r){var s,o,l,h,u,d,p,c,f,v,g,y,b,x,S,C,E,N,A,M,T,q,j,F,D=t.data,H=r+r+1,W=a-1,O=n-1,I=r+1,P=I*(I+1)/2,L=new m,R=L;for(l=1;H>l;l++)if(R=R.next=new m,l==I)var B=R;R.next=L;var z=null,Y=null;p=d=0;var X=k[r],K=w[r];for(o=0;n>o;o++){for(C=E=N=A=c=f=v=g=0,y=I*(M=D[d]),b=I*(T=D[d+1]),x=I*(q=D[d+2]),S=I*(j=D[d+3]),c+=P*M,f+=P*T,v+=P*q,g+=P*j,R=L,l=0;I>l;l++)R.r=M,R.g=T,R.b=q,R.a=j,R=R.next;for(l=1;I>l;l++)h=d+((l>W?W:l)<<2),c+=(R.r=M=D[h])*(F=I-l),f+=(R.g=T=D[h+1])*F,v+=(R.b=q=D[h+2])*F,g+=(R.a=j=D[h+3])*F,C+=M,E+=T,N+=q,A+=j,R=R.next;for(z=L,Y=B,s=0;a>s;s++)D[d+3]=j=g*X>>K,0!=j?(j=255/j,D[d]=(c*X>>K)*j,D[d+1]=(f*X>>K)*j,D[d+2]=(v*X>>K)*j):D[d]=D[d+1]=D[d+2]=0,c-=y,f-=b,v-=x,g-=S,y-=z.r,b-=z.g,x-=z.b,S-=z.a,h=p+((h=s+r+1)<W?h:W)<<2,C+=z.r=D[h],E+=z.g=D[h+1],N+=z.b=D[h+2],A+=z.a=D[h+3],c+=C,f+=E,v+=N,g+=A,z=z.next,y+=M=Y.r,b+=T=Y.g,x+=q=Y.b,S+=j=Y.a,C-=M,E-=T,N-=q,A-=j,Y=Y.next,d+=4;p+=a}for(s=0;a>s;s++){for(E=N=A=C=f=v=g=c=0,d=s<<2,y=I*(M=D[d]),b=I*(T=D[d+1]),x=I*(q=D[d+2]),S=I*(j=D[d+3]),c+=P*M,f+=P*T,v+=P*q,g+=P*j,R=L,l=0;I>l;l++)R.r=M,R.g=T,R.b=q,R.a=j,R=R.next;for(u=a,l=1;r>=l;l++)d=u+s<<2,c+=(R.r=M=D[d])*(F=I-l),f+=(R.g=T=D[d+1])*F,v+=(R.b=q=D[d+2])*F,g+=(R.a=j=D[d+3])*F,C+=M,E+=T,N+=q,A+=j,R=R.next,O>l&&(u+=a);for(d=s,z=L,Y=B,o=0;n>o;o++)h=d<<2,D[h+3]=j=g*X>>K,j>0?(j=255/j,D[h]=(c*X>>K)*j,D[h+1]=(f*X>>K)*j,D[h+2]=(v*X>>K)*j):D[h]=D[h+1]=D[h+2]=0,c-=y,f-=b,v-=x,g-=S,y-=z.r,b-=z.g,x-=z.b,S-=z.a,h=s+((h=o+I)<O?h:O)*a<<2,c+=C+=z.r=D[h],f+=E+=z.g=D[h+1],v+=N+=z.b=D[h+2],g+=A+=z.a=D[h+3],z=z.next,y+=M=Y.r,b+=T=Y.g,x+=q=Y.b,S+=j=Y.a,C-=M,E-=T,N-=q,A-=j,Y=Y.next,d+=a}return t}function p(t,e,i,a,n,r){if(!(Number.isNaN(r)||1>r)){r|=0;var s=h(t,e,i,a,n);s=c(s,e,i,a,n,r),t.getContext("2d").putImageData(s,e,i)}}function c(t,e,i,a,n,r){var s,o,l,h,u,d,p,c,f,v,g,y,b,x,S,C,E,N,A,M,T=t.data,q=r+r+1,j=a-1,F=n-1,D=r+1,H=D*(D+1)/2,W=new m,O=W;for(l=1;q>l;l++)if(O=O.next=new m,l==D)var I=O;O.next=W;var P=null,L=null;p=d=0;var R=k[r],B=w[r];for(o=0;n>o;o++){for(x=S=C=c=f=v=0,g=D*(E=T[d]),y=D*(N=T[d+1]),b=D*(A=T[d+2]),c+=H*E,f+=H*N,v+=H*A,O=W,l=0;D>l;l++)O.r=E,O.g=N,O.b=A,O=O.next;for(l=1;D>l;l++)h=d+((l>j?j:l)<<2),c+=(O.r=E=T[h])*(M=D-l),f+=(O.g=N=T[h+1])*M,v+=(O.b=A=T[h+2])*M,x+=E,S+=N,C+=A,O=O.next;for(P=W,L=I,s=0;a>s;s++)T[d]=c*R>>B,T[d+1]=f*R>>B,T[d+2]=v*R>>B,c-=g,f-=y,v-=b,g-=P.r,y-=P.g,b-=P.b,h=p+((h=s+r+1)<j?h:j)<<2,x+=P.r=T[h],S+=P.g=T[h+1],C+=P.b=T[h+2],c+=x,f+=S,v+=C,P=P.next,g+=E=L.r,y+=N=L.g,b+=A=L.b,x-=E,S-=N,C-=A,L=L.next,d+=4;p+=a}for(s=0;a>s;s++){for(S=C=x=f=v=c=0,d=s<<2,g=D*(E=T[d]),y=D*(N=T[d+1]),b=D*(A=T[d+2]),c+=H*E,f+=H*N,v+=H*A,O=W,l=0;D>l;l++)O.r=E,O.g=N,O.b=A,O=O.next;for(u=a,l=1;r>=l;l++)d=u+s<<2,c+=(O.r=E=T[d])*(M=D-l),f+=(O.g=N=T[d+1])*M,v+=(O.b=A=T[d+2])*M,x+=E,S+=N,C+=A,O=O.next,F>l&&(u+=a);for(d=s,P=W,L=I,o=0;n>o;o++)h=d<<2,T[h]=c*R>>B,T[h+1]=f*R>>B,T[h+2]=v*R>>B,c-=g,f-=y,v-=b,g-=P.r,y-=P.g,b-=P.b,h=s+((h=o+D)<F?h:F)*a<<2,c+=x+=P.r=T[h],f+=S+=P.g=T[h+1],v+=C+=P.b=T[h+2],P=P.next,g+=E=L.r,y+=N=L.g,b+=A=L.b,x-=E,S-=N,C-=A,L=L.next,d+=a}return t}function m(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}var f={};f["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},f.classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},f.createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,i,a){return i&&t(e.prototype,i),a&&t(e,a),e}}();var v={rangeToBool:e,appendOptions:t,extendRecursive:i,sanitizeKey:n,toNumber:r,keyToTile:a,quantile:s,uniqueValues:o},g={map:{longitudeKey:"longitude",latitudeKey:"latitude",countryIdentifierKey:"country_code",countryIdentifierType:"iso_a2",zoom:!0,saveState:!0,exportSvg:null,exportSvgClient:!1,ratioFromWidth:.5,scaleHeight:1,scaleZoom:[1,10],fitContentMargin:10,autoFitContent:!1,tooltipClassName:"popover bottom",countries:{legend:!1,attr:{fill:"#FCFCFC",stroke:"#CCC","stroke-width":.5},tooltipClassName:"mt-map-tooltip popover bottom"},heatmap:{mask:!0,weightByAttribute:null,weightByAttributeScale:"linear",circles:{min:1,max:90,step:4,color:"#FF0000",colorStrength:1,blur:4},borders:{stroke:1,opacity:.1,color:"#000"}},markers:{attr:{r:4,fill:"blue",stroke:"#CCC","stroke-width":.5},tooltipClassName:"mt-map-tooltip popover bottom"},title:{fontSize:12,fontFamily:"Helevetica, Arial, Sans-Serif"}},filters:{saveState:!0},table:{className:"table table-striped table-bordered",collapseRowsBy:[]}},y=function(){function t(e){f.classCallCheck(this,t),this.legendWidth=220,this.map=e,this.node=this.map.svg.append("g").attr("id","mt-map-legend").attr("transform","translate("+(this.map.getWidth()-350)+", "+(this.map.getHeight()-60)+")"),this.buildIndice()}return f.createClass(t,[{key:"buildScale",value:function(t){var e=this.node.append("defs").append("linearGradient").attr("id","mt-map-legend-gradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%");if(this.map.options.countries.attr.fill.minNegative&&this.map.options.countries.attr.fill.maxNegative){var i=Math.round((0-t[0])/(t[1]-t[0])*100),a=i+1;e.append("stop").attr("offset","0%").attr("style","stop-color:"+this.map.options.countries.attr.fill.maxNegative+";stop-opacity:1"),e.append("stop").attr("offset",i+"%").attr("style","stop-color:"+this.map.options.countries.attr.fill.minNegative+";stop-opacity:1"),e.append("stop").attr("offset",a+"%").attr("style","stop-color:"+this.map.options.countries.attr.fill.min+";stop-opacity:1")}else e.append("stop").attr("offset","0%").attr("style","stop-color:"+this.map.options.countries.attr.fill.min+";stop-opacity:1");e.append("stop").attr("offset","100%").attr("style","stop-color:"+this.map.options.countries.attr.fill.max+";stop-opacity:1"),this.node.append("rect").attr("x",40).attr("y",0).attr("width",this.legendWidth).attr("height",15).attr("fill","url(#mt-map-legend-gradient)")}},{key:"buildIndice",value:function(){var t=this.node.append("g").attr("id","mt-map-legend-indice").attr("style","display:none").attr("transform","translate(36,15)");t.append("polygon").attr("points","4.5 0 9 5 0 5").attr("fill","#222222"),t.append("text").attr("x",4).attr("y",13).attr("width",10).attr("height",10).attr("text-anchor","middle").attr("font-family","Arial").attr("font-size","9").attr("stroke","#FFFFF").attr("stroke-width","1").attr("fill","#222222").text("0"),this.node.append("text").attr("id","mt-map-legend-min").attr("x",35).attr("y",13).attr("width",35).attr("height",15).attr("text-anchor","end").attr("font-family","Arial").attr("font-size","14").attr("stroke","#FFFFF").attr("stroke-width","3").attr("fill","#222222").text("0"),this.node.append("text").attr("id","mt-map-legend-max").attr("y",13).attr("x",265).attr("width",40).attr("height",15).attr("text-anchor","start").attr("font-family","Arial").attr("font-size","14").attr("stroke","#FFFFF").attr("stroke-width","3").attr("fill","#222222").text("1")}},{key:"updateExtents",value:function(t){this.node.select("#mt-map-legend").style("opacity",t[0]===t[1]?0:1),this.node.selectAll("mt-map-legend-min").length&&(this.node.select("#mt-map-legend-min").text(Math.round(t[0])),this.node.select("#mt-map-legend-max").text(Math.round(t[1])),this.buildScale(t))}},{key:"indiceChange",value:function(t){if(Number.isNaN(t))this.node.select("#mt-map-legend-indice").attr("style","display:none");else{var e=parseInt(this.node.select("#mt-map-legend-max").text(),10),i=parseInt(this.node.select("#mt-map-legend-min").text(),10),a=Math.round((0-(i-t)/(e-i))*this.legendWidth);this.node.select("#mt-map-legend-indice text").text(Math.round(t)),this.node.select("#mt-map-legend-indice").attr("style","display:block").attr("transform","translate("+(36+a)+",15)")}}}]),t}(),b=function(){function t(e,i){return f.classCallCheck(this,t),this.map=e,this.src=i.src,this.position=i.position,this.width=parseInt(i.width,10),this.height=parseInt(i.height,10),this.padding=i.padding||10,this.style=i.style,i.src?Number.isNaN(this.width)?void console.warn("Watermak width not found"):Number.isNaN(this.height)?void console.warn("Watermak height not found"):void(window.btoa?this.buildWatermark():console.warn("Watermark not rendered: btoa error")):void console.warn("Watermak src not found")}return f.createClass(t,[{key:"buildWatermark",value:function(){var t=this;d3.xhr(this.src,function(e){var i=0;t.map.options.title&&(i=30);var a=void 0,n=void 0,r=void 0;if(-1!==t.src.indexOf(".svg"))a="image/svg+xml";else if(-1!==t.src.indexOf(".jpg")||-1!==t.src.indexOf(".jpeg"))a="image/jpeg";else{if(-1===t.src.indexOf(".png"))return void console.warn("invalid watermark mime type");a="image/png"}var s="data:"+a+";base64,"+window.btoa(e.responseText);if(t.position){var o=t.position.split(" ");"top"===o[0]?r=t.padding:"middle"===o[0]?r=(t.map.getHeight()-t.height)/2:"bottom"===o[0]?r=t.map.getHeight()-t.height-t.padding-i:console.warn("position should be (top|middle|bottom) (left|middle|right)"),"left"===o[1]?n=t.padding:"middle"===o[1]?n=(t.map.getWidth()-t.width)/2:"right"===o[1]?n=t.map.getWidth()-t.width-t.padding:console.warn("position should be (top|middle|bottom) (left|middle|right)")}t.node=t.map.svg.append("image").attr("xlink:href",s).attr("width",t.width).attr("height",t.height),n&&r&&t.node.attr("x",n).attr("y",r),t.style&&t.node.attr("style",t.style)})}}]),t}(),k=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],w=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],x={image:l,canvasRGBA:u,canvasRGB:p,imageDataRGBA:d,imageDataRGB:c},S=function(){function t(e,i,a){var n=this;f.classCallCheck(this,t);var r=this;this.maptable=e,this.scale=1,this.transX=0,this.transY=0,this.options=i,this.jsonWorld=a,this.containerSelector=e.options.target,this.container=document.querySelector(e.options.target);var s=this.container.querySelector(".mt-map-container"),o=this.container.querySelector("#mt-map");o&&(s.parentNode.insertBefore(s,o),o.parentNode.removeChild(o)),this.node=document.createElement("div"),this.node.setAttribute("id","mt-map"),s.appendChild(this.node),this.svg=d3.select(this.node).append("svg").attr("id","mt-map-svg").attr("xmlns","http://www.w3.org/2000/svg").attr("xmlns:xlink","http://www.w3.org/1999/xlink").attr("viewBox","0 0 "+this.getWidth()+" "+this.getHeight()).attr("width",this.getWidth()).attr("height",this.getHeight()),this.projection=d3.geo.equirectangular().translate([this.getWidth()/2,this.getHeight()/(2*this.options.scaleHeight)]).scale(this.getWidth()/640*100).rotate([-12,0]).precision(.1),this.path=d3.geo.path().projection(this.projection),this.maptable.rawData.forEach(function(t){t.longitude=parseFloat(t[r.options.longitudeKey]),t.latitude=parseFloat(t[r.options.latitudeKey]);var e=[0,0];Number.isNaN(t.longitude)||Number.isNaN(t.latitude)||(e=r.projection([t.longitude,t.latitude])),t.x=e[0],t.y=e[1]}),this.zoomListener=d3.behavior.zoom().scaleExtent(this.options.scaleZoom).on("zoom",this.rescale.bind(this)),this.options.zoom&&(this.svg=this.svg.call(this.zoomListener.bind(this))),this.options.markers&&(this.tooltipMarkersNode=d3.select(this.node).append("div").attr("id","mt-map-markers-tooltip").attr("class","mt-map-tooltip "+this.options.markers.tooltipClassName).style("display","none")),this.options.countries&&(this.tooltipCountriesNode=d3.select(this.node).append("div").attr("id","mt-map-countries-tooltip").attr("class","mt-map-tooltip "+this.options.countries.tooltipClassName).style("display","none")),this.layerGlobal=this.svg.append("g").attr("class","mt-map-global"),this.layerCountries=this.layerGlobal.append("g").attr("class","mt-map-countries"),this.layerHeatmap=this.layerGlobal.append("g").attr("class","mt-map-heatmap"),this.layerMarkers=this.layerGlobal.append("g").attr("class","mt-map-markers"),this.options.watermark&&(this.watermark=new b(this,this.options.watermark)),this.options.title&&this.buildTitle(),(this.options.exportSvgClient||this.options.exportSvg)&&this.addExportSvgCapability(),this.options.width||window.addEventListener("resize",function(){n.svg.attr("width",n.getWidth()),n.svg.attr("height",n.getHeight()),n.rescale()}),this.loadGeometries()}return f.createClass(t,[{key:"scaleAttributes",value:function(){return Math.pow(this.scale,2/3)}},{key:"getWidth",value:function(){return this.options.width?this.options.width:this.node.offsetWidth}},{key:"getHeight",value:function(){var t=this.options.title?30:0;return!this.options.height&&this.options.ratioFromWidth?this.getWidth()*this.options.ratioFromWidth*this.options.scaleHeight+t:this.options.height*this.options.scaleHeight+t}},{key:"loadGeometries",value:function(){this.options.filterCountries&&(this.jsonWorld.objects.countries.geometries=this.jsonWorld.objects.countries.geometries.filter(this.options.filterCountries)),this.options.countries&&this.buildCountries(),this.options.heatmap&&this.buildHeatmap()}},{key:"buildHeatmap",value:function(){var t=topojson.merge(this.jsonWorld,this.jsonWorld.objects.countries.geometries);if(this.options.heatmap.disableMask||(this.maskHeatmap=this.layerHeatmap.append("defs").append("clipPath").attr("id","mt-map-heatmap-mask"),this.maskHeatmap.datum(t).append("path").attr("class","mt-map-heatmap-mask-paths").attr("d",this.path)),this.imgHeatmap=this.layerHeatmap.append("image").attr("width",this.getWidth()).attr("height",this.getHeight()).attr("x",0).attr("y",0).attr("class","mt-map-heatmap-img"),this.options.heatmap.mask&&(this.imgHeatmap=this.imgHeatmap.attr("clip-path","url(#mt-map-heatmap-mask)")),this.options.heatmap.borders){var e=topojson.mesh(this.jsonWorld,this.jsonWorld.objects.countries,function(t,e){return t!==e});this.bordersHeatmap=this.layerHeatmap.append("g").attr("class","mt-map-heatmap-borders"),this.bordersHeatmap.selectAll("path.mt-map-heatmap-borders-paths").data([t,e]).enter().append("path").attr("class","mt-map-heatmap-borders-paths").attr("fill","none").attr("stroke-width",this.options.heatmap.borders.stroke).attr("stroke",this.options.heatmap.borders.color).attr("style","opacity: "+this.options.heatmap.borders.opacity).attr("d",this.path)}}},{key:"getMagnitudeScale",value:function(t){var e=this.options.heatmap,i=t.length;if(!i)return function(){return 0};var a=d3.scale.linear().domain([1,i]).range([1,.25]),n=a(i),r=d3.scale.linear().domain([e.circles.min,20]).range([n,0]);return function(t){return r(t)}}},{key:"getDatumScale",value:function(){var t=this;if(!this.options.heatmap.weightByAttribute)return function(){return 1};var e=d3.extent(this.maptable.data,this.options.heatmap.weightByAttribute),i="log"===this.options.heatmap.weightByAttributeScale?d3.scale.log:d3.scale.linear,a=i().domain(e).range([.5,1]);return function(e){var i=t.options.heatmap.weightByAttribute(e);return i?a(i):0}}},{key:"getHeatmapData",value:function(){var t=this,e=d3.select(this.node).append("canvas").attr("id","mt-map-heatmap-canvas").attr("width",this.getWidth()).attr("height",this.getHeight()).attr("style","display: none;"),i=e.node().getContext("2d");i.globalCompositeOperation="multiply";var a=d3.range(this.options.heatmap.circles.min,this.options.heatmap.circles.max,this.options.heatmap.circles.step),n=this.getDatumScale(),r=this.maptable.data.filter(function(t){return n(t)>.1}),s=this.path.context(i),o=this.getMagnitudeScale(r),l=d3.scale.linear().domain([1,0]).range(["#000000","#FFFFFF"]);i.beginPath(),i.rect(0,0,this.getWidth(),this.getHeight()),i.fillStyle="#ffffff",i.fill(),i.closePath();var h=function(e){var i=t.options.heatmap.circles.colorStrength,a=1+(i-1)/100;return i>1?(2-a)*e+a-1:i*e};r.forEach(function(t){var e=n(t);a.forEach(function(a){var n=h(o(a)*e);n>0&&(i.beginPath(),s(d3.geo.circle().origin([t.longitude,t.latitude]).angle(a-1e-4)()),i.fillStyle=l(n),i.fill(),i.closePath())})}),x.canvasRGBA(e.node(),0,0,this.getWidth(),this.getHeight(),this.options.heatmap.circles.blur),i.beginPath(),i.globalCompositeOperation="screen",i.rect(0,0,this.getWidth(),this.getHeight()),i.fillStyle=this.options.heatmap.circles.color,i.fill(),i.closePath();var u=e.node().toDataURL();return e.remove(),u}},{key:"updateHeatmap",value:function(){var t=this.getHeatmapData();this.imgHeatmap.attr("xlink:href",t)}},{key:"buildCountries",value:function(){this.dataCountries=topojson.feature(this.jsonWorld,this.jsonWorld.objects.countries).features,this.layerCountries.selectAll(".mt-map-country").data(this.dataCountries).enter().insert("path").attr("class","mt-map-country").attr("d",this.path),this.legendCountry={},this.shouldRenderLegend()&&(this.legendCountry.fill=new y(this))}},{key:"shouldRenderLegend",value:function(){var t=this.options.countries.attr.fill;if(!t)return!1;if(!t.legend||!t.min||!t.max)return!1;if(t.aggregate&&t.aggregate.scale){var e="function"==typeof t.aggregate.scale?t.aggregate.scale.bind(this.maptable)():t.aggregate.scale;if("linear"!==e)return!1}return!0}},{key:"updateCountries",value:function(){var t=this,e=d3.nest().key(function(e){return e[t.options.countryIdentifierKey]}).entries(this.maptable.data);this.dataCountries.forEach(function(i){i.key=i.properties[t.options.countryIdentifierType];var a=e.filter(function(t){return t.key===i.key});i.values=0===a.length?[]:a[0].values,i.attr={},i.rollupValue={}}),Object.keys(this.options.countries.attr).forEach(function(e){t.setAttrValues(e,t.options.countries.attr[e],t.dataCountries)});var i=d3.selectAll(".mt-map-country").each(function(t){var e=this;Object.keys(t.attr).forEach(function(i){d3.select(e).attr(i,t.attr[i])})});Object.keys(this.options.countries.attr).forEach(function(e){var a=t.options.countries.attr[e];if("object"===("undefined"==typeof a?"undefined":f["typeof"](a))&&a.legend&&void 0!=t.legendCountry[e]){var n=d3.extent(t.dataCountries,function(t){return Number(t.attrProperties[e].value)});t.legendCountry[e].updateExtents(n),i.on("mouseover",function(i){t.legendCountry[e].indiceChange(i.attrProperties[e].value)}).on("mouseout",function(){t.legendCountry[e].indiceChange(NaN)})}}),this.options.countries&&this.options.countries.tooltip&&this.activateTooltip(i,this.tooltipCountriesNode,this.options.countries.tooltip,!0)}},{key:"updateMarkers",value:function(){var t=this,e=function(t){return t.longitude+","+t.latitude};this.dataMarkers=d3.nest().key(e).entries(this.maptable.data).filter(function(t){return 0!==t.values[0].x}),this.dataMarkers.forEach(function(t){t.attr={},t.attrProperties={}}),Object.keys(this.options.markers.attr).forEach(function(e){t.setAttrValues(e,t.options.markers.attr[e],t.dataMarkers)});var i=this.layerMarkers.selectAll(".mt-map-marker").data(this.dataMarkers),a=i.enter();a=this.options.markers.customTag?this.options.markers.customTag(a):a.append("svg:circle");var n=this.options.markers.className?this.options.markers.className:"";a.attr("class","mt-map-marker "+n),i.exit().transition().attr("r",0).attr("fill","#eee").style("opacity",0).remove();var r=this.options.markers.attrX?this.options.markers.attrX:"cx",s=this.options.markers.attrY?this.options.markers.attrY:"cy",o=this.options.markers.attrXDelta?this.options.markers.attrXDelta:0,l=this.options.markers.attrYDelta?this.options.markers.attrYDelta:0,h=i.attr(r,function(t){return t.values[0].x+o}).attr(s,function(t){return t.values[0].y+l});d3.selectAll(this.containerSelector+" .mt-map-marker").each(function(t){var e=this;Object.keys(t.attr).forEach(function(i){d3.select(e).attr(i,t.attr[i])})}),this.options.markers.tooltip&&this.activateTooltip(h,this.tooltipMarkersNode,this.options.markers.tooltip,!1),this.rescale()}},{key:"fitContent",value:function(){if(0===this.maptable.data.length)return this.transX=0,this.transY=0,this.scale=1,void this.zoomListener.translate([this.transX,this.transY]).scale(this.scale);var t=d3.extent(this.maptable.data,function(t){return t.x}),e=d3.extent(this.maptable.data,function(t){return t.y}),i=this.getWidth()/this.getHeight(),a=20+(this.options.title?30:0),n=t[1]-t[0]+a,r=e[1]-e[0]+a,s=n/i,o=r*i,l=0,h=0;o>=n?l=(o-n)/2:h=(s-r)/2,t[0]-=this.options.fitContentMargin+l,t[1]+=this.options.fitContentMargin+l,e[0]-=this.options.fitContentMargin+h,e[1]+=this.options.fitContentMargin+h,this.scale=this.getWidth()/(t[1]-t[0]),this.transX=-1*t[0]*this.scale,this.transY=-1*e[0]*this.scale,this.zoomListener.translate([this.transX,this.transY]).scale(this.scale)}},{key:"buildTitle",value:function(){var t=this.svg.append("svg").attr("width",this.getWidth()).attr("x",0).attr("y",this.getHeight()-30).attr("height",30);this.options.title.bgColor&&t.append("rect").attr("x",0).attr("y",0).attr("width",this.getWidth()).attr("height",30).attr("fill",this.options.title.bgColor),t.append("text").attr("id","mt-map-title").attr("x",20).attr("font-size",this.options.title.fontSize).attr("font-family",this.options.title.fontFamily).attr("y",20),this.options.title.source&&t.append("text").attr("y",20).attr("x",this.getWidth()-20).attr("text-anchor","end").attr("font-size",this.options.title.fontSize).attr("font-family",this.options.title.fontFamily).html(this.options.title.source())}},{key:"encodeTranslation",value:function(t){var e=t[0]/(this.scale*this.getWidth()),i=t[1]/(this.scale*this.getHeight());return[e,i]}},{key:"decodeTranslation",value:function(t){var e=t[0]*this.getWidth()*this.scale,i=t[1]*this.getHeight()*this.scale;return[e,i]}},{key:"restoreState",value:function(t){if(t&&3===t.length){this.scale=t[0];var e=this.decodeTranslation([t[1],t[2]]);this.transX=e[0],this.transY=e[1],this.zoomListener.scale(t[0]).translate(e).event(this.svg)}}},{key:"saveState",value:function(){var t=this.encodeTranslation([this.transX,this.transY]),e=[this.scale,t[0],t[1]];1!==e[0]&&0!==e[1]&&0!==e[2]?this.maptable.saveState("zoom",e):this.maptable.removeState("zoom")}},{key:"rescale",value:function(){var t=this;d3.event&&d3.event.translate&&(this.scale=d3.event.scale,this.transX=1===this.scale?0:d3.event.translate[0],this.transY=1===this.scale?0:d3.event.translate[1]);var e=0,i=0,a=this.getWidth()*(1-this.scale),n=this.getHeight()*(1-this.scale);this.transY>i?this.transY=i:this.transY<n&&(this.transY=n),this.transX>e?this.transX=e:this.transX<a&&(this.transX=a),d3.event&&d3.event.translate&&(d3.event.translate[0]=this.transX,d3.event.translate[1]=this.transY),this.layerGlobal.attr("transform","translate("+this.transX+", "+this.transY+")scale("+this.scale+")"),t.tooltipCountriesNode&&t.tooltipCountriesNode.attr("style","display:none;"),t.tooltipMarkersNode&&t.tooltipMarkersNode.attr("style","display:none;"),this.options.markers&&d3.selectAll(this.containerSelector+" .mt-map-marker").each(function(e){e.attr["stroke-width"]&&d3.select(this).attr("stroke-width",e.attr["stroke-width"]/t.scaleAttributes()),e.attr.r&&d3.select(this).attr("r",e.attr.r/t.scaleAttributes())}),this.options.countries&&d3.selectAll(this.containerSelector+" .mt-map-country").style("stroke-width",this.options.countries.attr["stroke-width"]/this.scale),this.options.heatmap&&this.options.heatmap.borders&&d3.selectAll(this.containerSelector+" .mt-map-heatmap-borders-paths").style("stroke-width",this.options.heatmap.borders.stroke/this.scale),this.maptable.firstExecution&&this.options.saveState&&this.saveState()}},{key:"setAttrValues",value:function(t,e,i){var a=this;if("number"==typeof e||"string"==typeof e)i.forEach(function(i){i.attr[t]=e});else if("function"==typeof e)i.forEach(function(i){i.attr[t]=e(i)});else{if("object"!==("undefined"==typeof e?"undefined":f["typeof"](e)))throw new Error("Maptable: Invalid value for "+t);var n="linear",r=null,s="count",o=d3.scale.linear();if(e.aggregate){if(r="function"==typeof e.aggregate.key?e.aggregate.key.bind(this.maptable)():e.aggregate.key,s="function"==typeof e.aggregate.mode?e.aggregate.mode.bind(this.maptable)():e.aggregate.mode,"function"==typeof e.aggregate.scale?n=e.aggregate.scale.bind(this.maptable)():e.aggregate.scale&&(n=e.aggregate.scale),!r||!s)throw new Error("MapTable: You should provide values 'key' & 'mode' for attr."+t+".aggregate");if("sum"===s)e.rollup=function(t){return t.map(function(t){return Number(t[r])}).reduce(function(t,e){return t+e},0)};else if("avg"===s)e.rollup=function(t){if(!t.length)return 0;var e=t.filter(function(t){return!Number.isNaN(Number(t[r]))});return e.map(function(t){return Number(t[r])}).reduce(function(t,e){return t+e},0)/e.length};else if("count"===s)e.rollup=function(t){return t.length};else if("min"===s)e.rollup=function(t){if(!t.length)return 0;var e=t.map(function(t){return Number(t[r])});return e.reduce(function(t,e){return t>e?e:t},e[0])};else if("max"===s)e.rollup=function(t){if(!t.length)return 0;var e=t.map(function(t){return Number(t[r])});return e.reduce(function(t,e){return e>t?e:t},e[0])};else if(-1!==s.indexOf("percentile")){var l=v.toNumber(s);e.rollup=function(t){if(!t.length)return 0;var e=t.map(function(t){return Number(t[r])});return v.quantile(e,l)}}else"function"==typeof e.rollup&&(e.rollup=e.rollup.bind(this.maptable));n&&(-1!==n.indexOf("log")?o=d3.scale.log().base(v.toNumber(n)||10):-1!==n.indexOf("pow")?o=d3.scale.pow().exponent(v.toNumber(n)||1):"sqrt"===n&&(o=d3.scale.sqrt()))}if(e.rollup||(e.rollup=function(t){return t.length}),!e.min||!e.max)throw new Error("MapTable: You should provide values 'min' & 'max' for attr."+t);if(i.forEach(function(i){var o=e.rollup(i.values);if(i.attrProperties||(i.attrProperties={}),i.attrProperties[t]||(i.attrProperties[t]={}),i.attrProperties[t].value=o,r){i.attrProperties[t].key=r,i.attrProperties[t].mode=s,i.attrProperties[t].scale=n;var l=a.maptable.columnDetails[r];i.attrProperties[t].columnDetails=l;var h={};h[r]=o,i.attrProperties[t].formatted=l&&l.cellContent?l.cellContent.bind(a.maptable)(h):o}}),"rank"===n){var h=v.uniqueValues([0].concat(i.map(function(e){return Math.floor(100*e.attrProperties[t].value)/100}).filter(function(t){return t>0}))),u=v.uniqueValues(i.map(function(e){return Math.floor(100*e.attrProperties[t].value)/100}).filter(function(t){return 0>t}));h.sort(function(t,e){return t-e}),u.sort(function(t,e){return e-t}),i.forEach(function(e){if(0!==e.attrProperties[t].value){var i=e.attrProperties[t].value>=0?h:u,a=i.indexOf(Math.floor(100*e.attrProperties[t].value)/100),n=Math.round(a/i.length*100),r=e.attrProperties[t].value<0?n-2*n:n;e.attrProperties[t].value=r}})}var d=d3.extent(i,function(e){return Number(e.attrProperties[t].value)});e.transform&&(d[0]=e.transform.bind(this.maptable)(d[0],this.maptable.data),d[1]=e.transform.bind(this.maptable)(d[1],this.maptable.data));var p=e.min,c=e.max;if("minValue"===e.min&&(p=d[0]),"maxValue"===e.max&&(c=d[1]),e.maxNegative&&!e.minNegative||!e.maxNegative&&e.minNegative)throw new Error("MapTable: maxNegative or minNegative undefined. Please declare both.");var m=e.maxNegative&&e.minNegative,g=void 0,y=void 0;m?(g=o.copy().domain([0,d[1]]).range([p,c]),y=o.copy().domain([d[0],0]).range([e.maxNegative,e.minNegative])):g=o.domain(d).range([p,c]),i.forEach(function(i){var n=void 0;if(!i.values.length||Number.isNaN(i.attrProperties[t].value)){if("undefined"==typeof e.empty)throw new Error("MapTable: no empty property found for attr."+t);n=e.empty}else{var r=i.attrProperties[t].value,s=e.transform?e.transform.bind(a.maptable)(r,a.maptable.data):r;n=m&&0>s?y(s):g(s)}i.attr[t]=n})}}},{key:"render",value:function(){this.options.markers&&this.updateMarkers(),this.options.countries&&this.updateCountries(),this.options.title&&this.updateTitle(),this.options.heatmap&&this.updateHeatmap(),this.options.autoFitContent&&(this.fitContent(),this.rescale()),this.options.onRender&&this.options.onRender.constructor===Function&&this.options.onRender.bind(this.maptable)()}},{key:"updateTitle",value:function(){var t=this;if(this.options.title.content){var e=this.maptable.data.filter(function(e){return 0!==e[t.options.latitudeKey]}).length,i=this.maptable.rawData.filter(function(e){
return 0!==e[t.options.latitudeKey]}).length,a="";this.maptable.filters&&(a=this.maptable.filters.getDescription()),this.container.querySelector("#mt-map-title").innerHTML=this.options.title.content.bind(this.maptable)(e,i,a,this.maptable.data,this.maptable.rawData,this.dataCountries)}}},{key:"activateTooltip",value:function(t,e,i,a){var n=this;t.on(a?"mousemove":"mouseover",function(t){var r=i.bind(this.maptable)(t);if(r){e.html(r).attr("style","display:block;position:fixed;");var s=void 0,o=void 0,l=e.node().offsetWidth/2;if(a){var h=n.node.getBoundingClientRect(),u=d3.mouse(n.svg.node()).map(function(t){return parseInt(t,10)});s=h.left+u[0]-l,o=h.top+u[1]+10}else{var d=this.getBoundingClientRect();s=d.left+d.width/2-l,o=d.top+d.height+2}e.attr("style","top:"+o+"px;left:"+s+"px;display:block;position:fixed;").on("mouseout",function(){e.style("display","none")})}}).on("mouseout",function(){e.style("display","none")})}},{key:"exportSvg",value:function(){var t=this.container.querySelector("#mt-map-svg"),e='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n'+(new XMLSerializer).serializeToString(t);if(this.options.exportSvgClient){if(!window.saveAs)throw new Error("MapTable: Missing FileSaver.js library");var i=new Blob([e],{type:"image/svg+xml"});window.saveAs(i,"visualization.svg")}else if(this.options.exportSvg){var a=this.node.querySelector("#mt-map-svg-form");a.querySelector('[name="data"]').value=e,a.submit()}}},{key:"addExportSvgCapability",value:function(){var t=document.createElement("div");t.setAttribute("id","mt-map-export"),this.container.querySelector("#mt-map").appendChild(t);var e=document.createElement("button");if(e.setAttribute("class","btn btn-xs btn-default"),e.innerHTML="Download",e.addEventListener("click",this.exportSvg.bind(this)),t.appendChild(e),this.options.exportSvg){var i=document.createElement("div");i.innerHTML='<form id="mt-map-svg-form" method="post"\n  action="'+this.options.exportSvg+'"><input type="hidden" name="data"></form>',t.appendChild(i)}}}]),t}(),C=function(){function t(e,i){var a=this;if(f.classCallCheck(this,t),this.maptable=e,this.options=i,this.criteria=[],this.options.show){var n=this.options.show.filter(function(t){return Object.keys(a.maptable.columnDetails).indexOf(t)<0});if(n.length>0)throw new Error('MapTable: invalid columns "'+n.join(", ")+'"');this.activeColumns=this.options.show}else this.activeColumns=Object.keys(this.maptable.columnDetails);this.container=document.createElement("div"),this.maptable.node.appendChild(this.container),this.containerSelector=e.options.target,this.container=document.querySelector(e.options.target),this.node=this.container.querySelector("#mt-filters"),this.node||(this.node=document.createElement("div"),this.node.setAttribute("id","mt-filters"),this.node.setAttribute("class","panel panel-default"),this.maptable.node.appendChild(this.node));var r=document.createElement("div");r.setAttribute("class","panel-heading");var s=document.createElement("button");s.setAttribute("id","mt-filters-reset"),s.setAttribute("class","btn btn-default btn-xs pull-right"),s.style.display="none",s.style.marginLeft=5,s.innerText="↺ Reset",s.addEventListener("click",this.reset),r.appendChild(s);var o=document.createElement("h3");o.setAttribute("class","panel-title"),o.appendChild(document.createTextNode("Filters")),r.appendChild(o),this.node.appendChild(r);var l=document.createElement("div");l.setAttribute("id","mt-filters-content"),l.setAttribute("class","panel-body");var h=document.createElement("div");h.setAttribute("id","mt-filters-elements"),l.appendChild(h);var u=document.createElement("a");u.setAttribute("id","mt-filters-new"),u.setAttribute("href","#"),u.innerText="+ New filter",u.addEventListener("click",this.add.bind(this)),l.appendChild(u),this.node.appendChild(l)}return f.createClass(t,[{key:"add",value:function(t){t&&t.preventDefault();var e=this.getPossibleFilters();if(0!==e.length){var i=e[0].key;this.create(i)}}},{key:"create",value:function(t,e){var i=this.buildRow(t);e?e.parentNode.replaceChild(i,e):this.node.querySelector("#mt-filters-elements").appendChild(i),this.criteria.push(t),this.maptable.render(),"none"===this.container.style.display&&this.toggle()}},{key:"remove",value:function(t){var e=this.node.querySelector('[data-mt-filter-name="'+t+'"]');e&&e.parentNode.removeChild(e);var i=this.criteria.indexOf(t);this.criteria.splice(i,1),this.maptable.render()}},{key:"reset",value:function(){for(var t=this.node.querySelectorAll("[data-mt-filter-name]"),e=0;e<t.length;e+=1)t[e].parentNode.removeChild(t[e]);this.criteria=[],this.maptable.render()}},{key:"exportFilters",value:function(){for(var t={},e=this.node.querySelector("#mt-filters-elements").childNodes,i=0;i<e.length;i+=1){var a=e[i],n=a.querySelector(".mt-filter-name").value,r=this.maptable.columnDetails[n],s=[r.filterMethod];if("compare"===r.filterMethod){var o=a.querySelector(".mt-filter-range");if(s[1]=o.value,"any"!==o.value)if("BETWEEN"===o.value){var l=a.querySelector(".mt-filter-value-min").value,h=a.querySelector(".mt-filter-value-max").value;""!==l&&""===h&&(s[2]=l,s[3]=h)}else{var u=a.querySelector(".mt-filter-value-min").value;s[2]=u}}else if("field"===r.filterMethod||"dropdown"===r.filterMethod){s[1]="";var d=a.querySelector(".mt-filter-value").value;s[2]=d}"any"!==s[1]&&s[2]&&""!==s[2]&&(t[n]=s)}return t}},{key:"setFilters",value:function(t){var e=this;this.reset(),Object.keys(t).forEach(function(i){e.create(i);var a=t[i],n=document.querySelector('#mt-filters-elements [data-mt-filter-name="'+i+'"]');n&&("compare"===a[0]?(n.querySelector(".mt-filter-range").value=a[1],"any"!==a[1]&&("BETWEEN"===a[1]?(n.querySelector(".mt-filter-value-min").value=a[2],n.querySelector(".mt-filter-value-max").value=a[3]):n.querySelector(".mt-filter-value-min").value=a[2])):("field"===a[0]||"dropdown"===a[0])&&(n.querySelector(".mt-filter-value").value=decodeURIComponent(a[2])))}),this.maptable.render()}},{key:"restoreState",value:function(t){t&&this.setFilters(t)}},{key:"getDescription",value:function(){for(var t=[],e=this.node.querySelector("#mt-filters-elements").childNodes,i=0;i<e.length;i+=1){var a=e[i],n=a.querySelector(".mt-filter-name").value,r=this.maptable.columnDetails[n],s="";if("compare"===r.filterMethod){var o=a.querySelector(".mt-filter-range");if("any"!==o.value)if("BETWEEN"===o.value){var l=a.querySelector(".mt-filter-value-min").value,h=a.querySelector(".mt-filter-value-max").value;if(""===l||""===h)continue;s+=r.title+" is between ",s+='<tspan font-weight="bold">'+l+'</tspan> and\n              <tspan font-weight="bold">'+h+"</tspan>"}else{var u=a.querySelector(".mt-filter-value-min").value;if(""===u)continue;s+=r.title+" is ",s+=o.options[o.selectedIndex].text,s+='<tspan font-weight="bold">'+u+"</tspan>"}}else if("field"===r.filterMethod||"dropdown"===r.filterMethod){var d=a.querySelector(".mt-filter-value").value;if(""===d)continue;var p="field"===r.filterMethod?"contains":"is";s+=r.title+" "+p+'\n          <tspan font-weight="bold">'+d+"</tspan>"}t.push(s)}return t.join(", ")}},{key:"buildRow",value:function(t){var e=this,i=this,a=this.getPossibleFilters(),n=this.maptable.columnDetails[t],r=document.createElement("div");r.setAttribute("class","mt-filter-row"),r.setAttribute("data-mt-filter-name",t);var s=document.createElement("button");s.setAttribute("class","btn btn-default pull-right"),s.setAttribute("data-mt-filter-btn-minus",1),s.innerText="– Remove this filter",s.addEventListener("click",function(){t=r.querySelector(".mt-filter-name").value,e.remove(t)}),r.appendChild(s);var o=document.createElement("span");o.setAttribute("class","mt-filters-and"),o.innerText="And ",r.appendChild(o);var l=document.createElement("select");l.setAttribute("class","mt-filter-name form-control form-control-inline"),v.appendOptions(l,a.map(function(t){return{text:t.title,value:t.key}})),l.value=t,l.addEventListener("change",function(){var t=this.parentNode.getAttribute("data-mt-filter-name"),e=this.value;i.create(e,this.parentNode),i.remove(t),i.refresh()}),r.appendChild(l);var h=document.createElement("span");h.innerText="field"===n.filterMethod?" contains ":" is ",r.appendChild(h);var u=null;"field"!==n.filterMethod&&"dropdown"!==n.filterMethod&&(u=document.createElement("select"),u.setAttribute("class","mt-filter-range form-control form-control-inline"),v.appendOptions(u,["any","=","≠","<",">","≤","≥","BETWEEN"].map(function(t){return{text:t,value:t}})),u.addEventListener("change",function(){i.handleRangeChange(this)}),r.appendChild(u),r.appendChild(document.createTextNode(" ")));var d=document.createElement("div");if(d.style.display="inline-block",d.setAttribute("class","mt-filter-value-container"),"compare"===n.filterMethod)["min","max"].forEach(function(t,i){var a=document.createElement("input");if(a.setAttribute("class","form-control form-control-inline mt-filter-value-"+t),a.setAttribute("type",n.filterInputType),a.addEventListener("keyup",e.maptable.render.bind(e.maptable)),a.addEventListener("change",e.maptable.render.bind(e.maptable)),d.appendChild(a),0===i){var r=document.createElement("span");r.setAttribute("class","mt-filter-value-and"),r.innerText=" and ",d.appendChild(r)}});else if("field"===n.filterMethod){var p=document.createElement("input");p.setAttribute("class","form-control form-control-inline mt-filter-value"),p.setAttribute("type","text"),p.addEventListener("keyup",this.maptable.render.bind(this.maptable)),p.addEventListener("change",this.maptable.render.bind(this.maptable)),d.appendChild(p)}else if("dropdown"===n.filterMethod){var c=document.createElement("select");c.setAttribute("class","form-control form-control-inline mt-filter-value");var m=d3.nest().key(function(e){return e[t]}).sortKeys(d3.ascending).entries(this.maptable.rawData);v.appendOptions(c,[{text:"Any",value:""}].concat(m.map(function(t){return{text:t.key,value:t.key}}))),c.addEventListener("change",this.maptable.render.bind(this.maptable)),d.appendChild(c)}return r.appendChild(d),u&&this.handleRangeChange(u),r}},{key:"handleRangeChange",value:function(t){var e=t.parentNode;"any"===t.value?e.querySelector(".mt-filter-value-container").style.display="none":(e.querySelector(".mt-filter-value-container").style.display="inline-block","BETWEEN"===t.value?(e.querySelector(".mt-filter-value-min").style.display="inline-block",e.querySelector(".mt-filter-value-and").style.display="inline-block",e.querySelector(".mt-filter-value-max").style.display="inline-block"):(e.querySelector(".mt-filter-value-min").style.display="inline-block",e.querySelector(".mt-filter-value-and").style.display="none",e.querySelector(".mt-filter-value-max").style.display="none"))}},{key:"getPossibleFilters",value:function(t){var e=this;return Object.keys(this.maptable.columnDetails).map(function(t){return v.extendRecursive({key:t},e.maptable.columnDetails[t])}).filter(function(i){return-1!==e.activeColumns.indexOf(i.key)&&(t&&t===i.key||-1===e.criteria.indexOf(i.key)&&i.filterMethod&&!i.isVirtual)})}},{key:"filterData",value:function(){var t=this,e=this;this.maptable.data=this.maptable.rawData.filter(function(i){for(var a=t.node.querySelectorAll(".mt-filter-row"),n=!0,r=0;r<a.length&&n;r+=1){var s=a[r],o=s.getAttribute("data-mt-filter-name"),l=e.maptable.columnDetails[o],h=l.dataParse;if("dropdown"===l.filterMethod){var u=s.querySelector(".mt-filter-value").value;if(""===u)continue;i[o]!==u&&(n=!1)}else if("field"===l.filterMethod){var d=s.querySelector(".mt-filter-value").value;if(""===d)continue;-1===i[o].toLowerCase().indexOf(d.toLowerCase())&&(n=!1)}else if("compare"===l.filterMethod){var p=s.querySelector(".mt-filter-range").value;if("BETWEEN"===p){var c=s.querySelector(".mt-filter-value-min").value,m=s.querySelector(".mt-filter-value-max").value;if(""===c||""===m)continue;h&&(h(i[o])<h(c)||h(i[o])>h(m))?n=!1:(parseInt(i[o],10)<parseInt(c,10)||parseInt(i[o],10)>parseInt(m,10))&&(n=!1)}else{var f=s.querySelector(".mt-filter-value-min").value;if(""===f)continue;h&&!v.rangeToBool(h(i[o]),p,h(f))?n=!1:h||v.rangeToBool(i[o],p,f)||(n=!1)}}}return n}),this.options.saveState&&this.maptable.saveState("filters",this.exportFilters())}},{key:"refresh",value:function(){for(var t=this.node.querySelectorAll(".mt-filter-name"),e=0;e<t.length;e+=1){var i=t[e],a=i.value,n=this.getPossibleFilters(a);i.innerHTML="",v.appendOptions(i,n.map(function(t){return{text:t.title,value:t.key}})),i.value=a}this.node.querySelectorAll(".mt-filters-and").length>0&&(this.node.querySelectorAll(".mt-filters-and")[0].style.visibility="hidden");var r=!this.getPossibleFilters().length;this.node.querySelector("#mt-filters-new").style.visibility=r?"hidden":"visible"}},{key:"toggle",value:function(){"none"===this.container.style.display?(this.container.style.display="block",0===this.criteria.length&&this.add()):this.container.style.display="none"}}]),t}(),E=function(){function t(e,i){var a=this;if(f.classCallCheck(this,t),this.maptable=e,this.options=i,this.options.defaultSorting?(Array.isArray(this.options.defaultSorting)&&2===this.options.defaultSorting.length?this.sorting=this.options.defaultSorting:this.sorting=[this.options.defaultSorting],this.sorting.forEach(function(t){t.mode||(t.mode="asc")})):this.sorting=[{key:Object.keys(this.maptable.data[0])[0],mode:"asc"}],this.initialSorting=this.sorting.map(function(t){return t.key+","+t.mode}).join(";"),this.isSorting=!1,this.containerSelector=e.options.target,this.container=document.querySelector(e.options.target),this.node=this.container.querySelector("#mt-table"),this.node||(this.node=document.createElement("div"),this.node.setAttribute("id","mt-table"),this.maptable.node.appendChild(this.node)),this.node=d3.select(this.node).append("table").attr("class",this.options.className),this.header=this.node.append("thead"),this.body=this.node.append("tbody"),this.options.show){var n=this.options.show.filter(function(t){return Object.keys(a.maptable.columnDetails).indexOf(t)<0});if(n.length>0)throw new Error('MapTable: invalid columns "'+n.join(", ")+'"');this.activeColumns=this.options.show}else this.activeColumns=Object.keys(this.maptable.columnDetails);this.header.selectAll("tr").data([1]).enter().append("tr").selectAll("th").data(this.activeColumns.map(function(t){return v.extendRecursive({key:t},a.maptable.columnDetails[t])})).enter().append("th").attr("class",function(t){var e=t.sorting?"mt-table-sortable":"";return e+=t.nowrap?" nowrap":""}).attr("data-key",function(t){return v.sanitizeKey(t.key)}).attr("onselectstart","return false;").attr("unselectable","on").attr("style",function(t){return t.nowrap?"white-space:nowrap;":""}).on("click",function(t){a.isSorting||(a.isSorting=!0,t.sorting&&a.sortColumn(t.key),a.isSorting=!1)}).text(function(t){return t.title}).attr("id",function(t){return"column_header_"+v.sanitizeKey(t.key)})}return f.createClass(t,[{key:"restoreState",value:function(t){if(t){var e=t.split(";"),i=[];e.forEach(function(t){var e=t.split(",");i.push({key:e[0],mode:e[1]||"asc"})}),this.sorting=i}}},{key:"saveState",value:function(){var t=this.sorting.map(function(t){return t.key+","+t.mode}).join(";");t!==this.initialSorting&&this.maptable.saveState("sort",t)}},{key:"render",value:function(){var t=this;this.applySort();var e=this.maptable.data;this.options.distinctBy&&(e=d3.nest().key(function(e){return e[t.options.distinctBy]}).entries(this.maptable.data).map(function(t){return t.values[0]})),this.body.selectAll("tr").data(e).enter().append("tr"),this.body.selectAll("tr").data(e).exit().remove();var i=[];this.body.selectAll("tr").data(e).attr("class",function(e){return t.options.rowClassName?"line "+t.options.rowClassName(e):"line"}).html(function(e){var a="";return t.activeColumns.forEach(function(n){var r=t.maptable.columnDetails[n];a+="<td",r.nowrap&&(a+=' style="white-space:nowrap;"'),a+=">",-1!==t.options.collapseRowsBy.indexOf(n)&&i[n]&&i[n]===e[n]||(r.cellContent?a+=r.cellContent(e):r.virtual?a+=r.virtual(e):e[n]&&"null"!==e[n]&&(a+=e[n]),-1!==t.options.collapseRowsBy.indexOf(n)&&(i[n]=e[n])),a+="</td>"}),a}),this.options.onRender&&this.options.onRender.constructor===Function&&this.options.onRender.bind(this.maptable)()}},{key:"applySort",value:function(){for(var t=this,e=this.container.querySelectorAll(".mt-table-sortable"),i=0;i<e.length;i+=1)e[i].setAttribute("class","mt-table-sortable");this.sorting.forEach(function(e){t.container.querySelector("#column_header_"+v.sanitizeKey(e.key)).setAttribute("class","mt-table-sortable sort_"+e.mode)}),this.maptable.data=this.maptable.data.sort(function(e,i){var a=!1;return t.sorting.forEach(function(n){var r="asc"===n.mode?d3.ascending:d3.descending,s=t.maptable.columnDetails[n.key],o=e[n.key],l=i[n.key];s.dataParse?(o=s.dataParse.bind(t.maptable)(o),l=s.dataParse.bind(t.maptable)(l)):s.virtual?(l=s.virtual.bind(t.maptable)(e),l=s.virtual.bind(t.maptable)(i)):"compare"===s.filterType?(o=Number(o),l=Number(l)):o instanceof String&&l instanceof String&&(o=o.toLowerCase(),l=l.toLowerCase()),a=a||r(o,l)}),a})}},{key:"sortColumn",value:function(t){var e=this.sorting.map(function(t){return t.key}).indexOf(t),i={key:t};-1===e?(i.mode="desc",d3.event&&d3.event.shiftKey?this.sorting[1]=i:this.sorting=[i]):("asc"===this.sorting[e].mode?this.sorting[e].mode="desc":this.sorting[e].mode="asc",d3.event.shiftKey||(this.sorting=[this.sorting[e]])),this.saveState(),this.render()}}]),t}(),N=function(){function t(e,i){f.classCallCheck(this,t),this.options=i,this.state={},this.saveStateTimeout={},this.removeStateTimeout=null,this.node=document.querySelector(e),this.node.setAttribute("style","position:relative;"),"json"===this.options.data.type?d3.json(this.options.data.path,this.loadData.bind(this)):"csv"===this.options.data.type?d3.csv(this.options.data.path,this.loadData.bind(this)):"tsv"===this.options.data.type&&d3.tsv(this.options.data.path,this.loadData.bind(this)),this.options.map&&this.options.map.heatmap&&delete this.options.map.countries}return f.createClass(t,[{key:"loadData",value:function(t,e){var i=this;if(t)throw t;if(this.rawData=e,this.options.data.preFilter&&(this.rawData=this.rawData.filter(this.options.data.preFilter)),this.setColumnDetails(),this.data=this.rawData.slice(),this.options.map){var a=document.createElement("div");a.setAttribute("class","mt-map-container");var n=-1!==navigator.userAgent.indexOf("MSIE")||navigator.appVersion.indexOf("Trident/")>0;if(this.options.map.heatmap&&n)return a.innerHTML='<div class="mt-loading">The heatmap feature is not supported with Internet Explorer.<br>Please use another modern browser to see this map.</div>',this.node.insertBefore(a,this.node.firstChild),a.querySelector(".mt-loading").style.display="block",this.options.map=!1,void this.buildComponenents();a.innerHTML='<div class="mt-loading">Loading...</div>',this.node.insertBefore(a,this.node.firstChild),a.querySelector(".mt-loading").style.display="block",d3.json(this.options.map.path,function(t,e){if(t)throw t;i.map=new S(i,i.options.map,e),a.querySelector(".mt-loading").style.display="none",i.buildComponenents()})}else this.buildComponenents()}},{key:"buildComponenents",value:function(){var t=this;this.options.filters&&(this.filters=new C(this,this.options.filters)),this.options.table&&(this.table=new E(this,this.options.table)),this.restoreState(),window.addEventListener("hashchange",function(){t.restoreState()}),this.render()}},{key:"loadState",value:function(t,e){if(e){var i=this.parseState(t);if(!i)return null;try{var a=JSON.parse(i);this.state[t]=a}catch(n){return console.log("Maptable: Invalid URL State for mt-"+t+" "+n.message),null}}else{var r=this.parseState(t);r&&(this.state[t]=r)}return this.state[t]}},{key:"restoreState",value:function(){this.map&&(this.loadState("zoom",!0),this.map.restoreState(this.state.zoom)),this.filters&&(this.loadState("filters",!0),this.filters.restoreState(this.state.filters)),this.table&&(this.loadState("sort",!1),this.table.restoreState(this.state.sort))}},{key:"parseState",value:function(t){var e=document.location.href.replace(/%21mt/g,"!mt").split("!mt-"+t+"=");return e[1]?decodeURIComponent(e[1].split("!mt")[0]):null}},{key:"removeState",value:function(t){window.clearTimeout(this.saveStateTimeout[t]),delete this.state[t],this.updateState()}},{key:"saveState",value:function(t,e){var i=this;window.clearTimeout(this.saveStateTimeout[t]),this.saveStateTimeout[t]=window.setTimeout(function(){i.state[t]=e,i.updateState()},200)}},{key:"updateState",value:function(){var t=this,e=document.location.href.split("#")[0],i="";Object.keys(this.state).forEach(function(e){if(t.state[e]){var a=t.state[e];if("object"===f["typeof"](t.state[e])){if(!Object.keys(t.state[e]).length)return;a=JSON.stringify(t.state[e])}i+="!mt-"+e+"="+encodeURIComponent(a)}}),""!==i&&(i="#"+i),document.location.href!==""+e+i&&window.history.pushState(null,null,""+e+i)}},{key:"render",value:function(){this.filters&&(this.filters.filterData(),this.filters.refresh()),this.map&&(this.map.render(),!this.firstExecution&&this.options.map.onComplete&&this.options.map.onComplete.constructor===Function&&this.options.map.onComplete.bind(this)()),this.table&&(this.table.render(),!this.firstExecution&&this.options.table.onComplete&&this.options.table.onComplete.constructor===Function&&this.options.table.onComplete.bind(this)()),!this.firstExecution&&this.options.onComplete&&this.options.onComplete.constructor===Function&&this.options.onComplete.bind(this)(),this.firstExecution=!0}},{key:"setColumnDetails",value:function(){var t=this;if(0!==t.rawData.length){var e={};Object.keys(t.rawData[0]).forEach(function(i){var a=/^[-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?$/,n=a.test(t.rawData[0][i]);e[i]={title:v.keyToTile(i),filterMethod:n?"compare":"field",filterInputType:n?"number":"text",sorting:!0},n&&(e[i].dataParse=function(t){return parseFloat(t)})}),t.columnDetails=v.extendRecursive(e,this.options.columns),Object.keys(t.columnDetails).forEach(function(e){t.columnDetails[e].isVirtual="function"==typeof t.columnDetails[e].virtual})}}}]),t}();if(d3.maptable=function(t){var e=void 0,i={},a={target:t,columns:{},data:{},map:null,filters:null,table:null};return i.map=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!topojson)throw new Error("Maptable requires topojson.js");if("string"!=typeof t.path)throw new Error("MapTable: map not provided");return a.map=t,i},i.json=function(t,e){return a.data.type="json",a.data.path=t,a.data.preFilter=e,i},i.csv=function(t,e){return a.data.type="csv",a.data.path=t,a.data.preFilter=e,i},i.tsv=function(t,e){return a.data.type="tsv",a.data.path=t,a.data.preFilter=e,i},i.filters=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return a.filters=t,i},i.table=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return a.table=t,i},i.columns=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return a.columns=t,i},i.render=function(i){if("string"!=typeof t||!document.querySelector(t))throw new Error("MapTable: target not found");if(!a.data||!a.data.path)throw new Error("MapTable: Please provide the path for your dataset json|csv|tsv");a.map&&!a.map.heatmap&&(a.map.heatmap=null),a.map&&a.map.markers===!1&&(a.map.markers=null),a.map&&a.map.countries===!1&&(a.map.countries=null),a.filters||(a.filters=null),a.onComplete=i;var n=v.extendRecursive(g,a);return e=new N(t,n),{render:function(){return e.render()},loadState:function(t,i){return e.loadState(t,i)},removeState:function(t){return e.removeState(t)},saveState:function(t,i){return e.saveState(t,i)}}},i},!d3)throw new Error("Maptable requires d3.js");var A=d3.maptable;return A}();