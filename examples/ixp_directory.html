<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<link rel="stylesheet" href="../src/maptable.css">

<div class="container">
<div id="ixp_dir"></div>
</div>
<svg id="svg_filters" height="0">
  <defs>
      <filter id="drop-shadow" x="-100%" y="-100%" width="400%" height="400%">
        <feGaussianBlur in="SourceAlpha" result="blur-out" stdDeviation="1" />
        <feOffset in="blur-out" result="the-shadow" dx="1" dy="1"/>
        <feColorMatrix in="the-shadow" result="color-out" type="matrix"
        values="0 0 0 0   0
        0 0 0 0   0
        0 0 0 0   0
        0 0 0 .3 0"/>
        <feBlend in="SourceGraphic" in2="color-out" mode="normal"/>
      </filter>
      <radialGradient id="gardientYellow"
      gradientUnits="objectBoundingBox" fx="30%" fy="30%">

      <stop offset="0%" style="stop-color:#FFFFFF" />
      <stop offset="40%" style="stop-color:#f9ea65" />
      <stop offset="100%" style="stop-color:#d4b91d" />
    </radialGradient>
  </defs>
    <defs>
      <filter id="drop-shadow-hover" x="-100%" y="-100%" width="400%" height="400%">
        <feGaussianBlur in="SourceAlpha" result="blur-out" stdDeviation="1" />
        <feOffset in="blur-out" result="the-shadow" dx="2" dy="2"/>
        <feColorMatrix in="the-shadow" result="color-out" type="matrix"
        values="0 0 0 0   0
        0 0 0 0   0
        0 0 0 0   0
        0 0 0 .3 0"/>
        <feBlend in="SourceGraphic" in2="color-out" mode="normal"/>
      </filter>
      <radialGradient id="gardientYellow"
      gradientUnits="objectBoundingBox" fx="30%" fy="30%">

      <stop offset="0%" style="stop-color:#FFFFFF" />
      <stop offset="40%" style="stop-color:#f9ea65" />
      <stop offset="100%" style="stop-color:#d4b91d" />
    </radialGradient>
  </defs>
</svg>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<script src="../vendor/topojson.js"></script>
<script src="../src/maptable.js"></script>

<script type="text/javascript">
  var ixp_map = MapTable.init("#ixp_dir", {
  	data: {
  		type: "csv",
  		path: "data/ixp.csv",
  		columns: [{
  			id: "region",
  			displayName: "Region",
  			type: "dropdown"
  		}, {
  			id: "country",
  			displayName: "Country",
  			type: "field"
  		}, {
  			id: "city",
  			displayName: "City",
  			type: "field"
  		}, {
  			id: "long_name",
  			displayName: "IXP Name",
  			type: "field",
  			cellContent: function(a) {
          return "<a href='https://prefix.pch.net/applications/ixpdir/detail.php?id=" + a.id + "' target='_blank'>" + a.long_name + "</a>";
  				//return "<a href='/ixp/details?id=" + a.id + "' target='_blank'>" + a.long_name + "</a>";
  			}
  		}, {
  			id: "prefixes",
  			displayName: "Prefixes",
  			type: "number",
  			cellContent: function(a) {
  				if (a["prefixes"] > 0) return a["prefixes"];
  				else return "";
  			}
  		}, {
  			id: "established",
  			displayName: "Established",
        input_type: "date",
  			type: "custom",
  			cellContent: function(a) {
  				months = new Array("", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec");
  				year = 1 * parseInt(a["established"].substring(0, 4));
  				month = 1 * parseInt(a["established"].substring(4, 6));
  				if (!isNaN(month) && 0 != month) month = months[month];
  				else month = "";
  				day = 1 * parseInt(a["established"].substring(6, 8));
  				output = day + " " + month + " " + year;
  				if (isNaN(day) || 0 == day) output = month + " " + year;
  				if ("" == month) output = year;
  				if (isNaN(year) || 0 == year) output = "";
  				return output;
  			},
  			dataFormat: function(a) {
          if(!a) return 0;
  				full_year = 1 * parseInt(a.substring(0, 4));
  				if (isNaN(full_year) || 0 == full_year) return null;
  				month = 1 * parseInt(a.substring(4, 6));
  				month = !isNaN(month) && 0 != month ? month - 1 : 0;
  				day = 1 * parseInt(a.substring(6, 8));
  				day = !isNaN(day) && 0 != day ? day - 1 : 0;
  				return new Date(full_year, month, day);
  			}
  		},
      {
  			id: "status",
  			displayName: "Status",
  			type: "dropdown"
  		}, {
  			id: "custom_1",
  			displayName: "URL",
  			type: "virtual",
  			cellContent: function(a) {
  				if (a["url"] && "" !== a["url"]) return "<a href='" + a["url"] + "' target='_blank'><i class=\"fa fa-external-link\"></i></a>";
  				return "";
  			}
  		}]
  	},
  	map: {
  		path: "maps/world-110m-wo-antarctica.json",
  		auto_width: true,
  		zoom: false,
  		scale_height: .86,
  		ratio_from_width: .48,
  		watermark: {
  			src: "https://www.pch.net/assets/img/pch_logo.svg",
  			width: 130,
  			height: 60,
  			position: "bottom left",
  			style: "opacity:0.1"
  		},
  		title: {
  			bgcolor: "#F5F5F5",
  			font_size: "11",
  			content: function(a, b, c) {
  				if (0 == a || 0 == b) out = "No IXP shown";
  				else if (a < b) out = 'Showing <tspan font-weight="bold">' + a + '</tspan> IXP from <tspan font-weight="bold">' + b + "</tspan>";
  				else out = '<tspan font-weight="bold">' + b + "</tspan> IXP shown";
  				if ("" != c) out += " — " + c;
  				return out;
  			},
  			source: function() {
  				return 'Source: <a xlink:href="http://www.pch.net/" target="_blank"><tspan font-weight="bold">pch.net</tspan></a>';
  			}
  		},
  		svg_filters: "#svg_filters",
  		markers: {
  			group_by: function(a) {
  				return a.city + ", " + a.country;
  			},
  			rollup: function(a) {
  				return a.length;
  			},
        tooltip: function(a) {
          out = '<div class="arrow"></div>';
          out += '<span class="badge pull-right"> ' + a.values.length + '</span><h3 class="popover-title"> ' + a.key + '</h3>';
          out += '<div class="popover-content">';

          for (i = 0; i < a.values.length; i++) out += " • " + a.values[i].long_name + "<br>";

          out += "</div>";
          return out;
        },
  			attr: {
  				r: ["min", "max", function(a) {
  					return 3 * Math.sqrt(a);
  				}],
  				fill: "url(#gardientYellow)",
  				stroke: "#d9d9d9",
  				"stroke-width": .5,
  				filter: "url(#drop-shadow)"
  			}
  		},
  		countries: {
  			group_by: function(a) {
  				return a['country_code'];
  			},
  			rollup: function(a) {
  				return a.length;
  			},
  			attr: {
  				fill: ["#a9b6c2", "#6c89a3"],
  				stroke: "#d9d9d9",
  				"stroke-width": .5
  			},
  			attr_empty: {
  				fill: "#f9f9f9"
  			}
  		}
  	},
  	table: {
  		rowClassName: function(a) {
  			if (a.status != "Active") return "inactive";
  			return "";
  		},
      class: "table table-striped",
  		default_sorting: {
  			id: "city",
  			mode: "asc"
  		},
  		collapse_rows_by: ["region", "country", "city"]
  	}
  });


</script>
