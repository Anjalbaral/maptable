<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="/maptable.css">
</head>
<body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.20/topojson.min.js"></script>
<script src="/maptable.js"></script>

<div id="vizContainer" class='container'></div>

<script>
d3.maptable('#vizContainer')
    .csv('ixp.csv')
    .map({
      path: "ne_110m_admin_0_countries.json",
      zoom: true,
      scaleHeight: 0.86,
      ratioFromWidth: 0.48,
      autoFitContent: true,
      countryIdentifierKey: 'country_code',
      countryIdentifierType: 'iso_a3',
      watermark: {
        src: 'https://www.pch.net/assets/img/pch_logo.svg',
        width: 130,
        height: 60,
        position: "bottom left",
        style: "opacity:0.1"
      },
      title: {
        bgColor: "#F5F5F5",
        fontSize: "11",
        content: function(a, b, c) {
          if (0 == a || 0 == b) out = "No IXP shown";
          else if (a < b) out = 'Showing <tspan font-weight="bold">' + a + '</tspan> IXP from <tspan font-weight="bold">' + b + "</tspan>";
          else out = '<tspan font-weight="bold">' + b + "</tspan> IXP shown";
          if ('' != c) out += " — " + c;
          return out;
        },
        source: function() {
          return 'Source: <a xlink:href="http://www.pch.net/" target="_blank"><tspan font-weight="bold">pch.net</tspan></a>';
        }
      },
      markers: {
        tooltip: function(a) {
          out = '<div class="arrow"></div>';
          out += '<span class="badge pull-right"> ' + a.values.length + '</span><h3 class="popover-title"> ' + a.values[0].city + ', ' + a.values[0].country_code + '</h3>';
          out += '<div class="popover-content">';
          for (i = 0; i < a.values.length; i++) out += " • " + a.values[i].long_name + "<br>";
          out += "</div>";
          return out;
        },
        attr: {
          r: {
            min: "minValue",
            max: "maxValue",
            transform: function(v) {
              return 3 * Math.sqrt(v);
            },
            rollup: function(a) {
              return a.length;
            },
          },
          fill: "yellow",
          stroke: "#d9d9d9",
          "stroke-width": 0.5
        }
      },
      countries: {
        attr: {
          fill: {
            min: "#a9b6c2",
            max: "#6c89a3",
            empty: "#f9f9f9",
            legend: true,
            rollup: function(a) {
              return a.length;
            },
          },
          stroke: "#d9d9d9",
          "stroke-width": 0.5
        }
      }
    })
    .table({
      show: ['region', 'country', 'city', 'long_name', 'prefixes', 'established'],
      rowClassName: function(a) {
        if (a.status != "Active") return "inactive";
        return '';
      },
      className: "table table-striped table-condensed",
      defaultSorting: {
        key: "city",
        mode: "asc"
      },
      collapseRowsBy: ["region", "country", "city"]
    })
    .filters({
      show: ['region', 'country', 'city', 'long_name', 'prefixes', 'established'],
    })
    .columns({
      region: {
        nowrap: true,
        filterMethod: 'dropdown'
      },
      prefixes: {
        cellContent: function(a) {
          if (a.prefixes > 0) return a.prefixes;
          return '';
        }
      },
      established: {
        filterInputType: "date",
        cellContent: function(a) {
          months = new Array('', "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec");
          year = 1 * parseInt(a["established"].substring(0, 4));
          month = 1 * parseInt(a["established"].substring(4, 6));
          if (!isNaN(month) && 0 != month) month = months[month];
          else month = '';
          day = 1 * parseInt(a["established"].substring(6, 8));
          output = day + " " + month + " " + year;
          if (isNaN(day) || 0 == day) output = month + " " + year;
          if ('' == month) output = year;
          if (isNaN(year) || 0 == year) output = '';
          return output;
        },
        dataParse: function(a) {
          if(!a) return 0;
          full_year = 1 * parseInt(a.substring(0, 4));
          if (isNaN(full_year) || 0 == full_year) return null;
          month = 1 * parseInt(a.substring(4, 6));
          month = !isNaN(month) && 0 != month ? month - 1 : 0;
          day = 1 * parseInt(a.substring(6, 8));
          day = !isNaN(day) && 0 != day ? day - 1 : 0;
          return new Date(full_year, month, day);
        }
      }
    })
    .render();
</script>


</body>
</html>
